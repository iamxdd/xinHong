/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("daibanshixiangCtrl",["$scope","$rootScope","$http","ngDialog","PagerExtends","layerAlert","serverUrls","PcService","$q",function(a,b,c,d,e,f,g,h,i){a.list=[],a.PcService=h,a.ItemContent={};var j=function(a){var b=Function;return new b("return "+a)()},k=j("("+localStorage.getItem("myCountInfo")+")"),l=k.memberid;a.navTabList=[{Id:1,Name:"信息核实",Active:!0},{Id:2,Name:"事项处理",Active:!1}],a.VerifyStates=[{Id:0,Name:"未核实",Active:!0},{Id:1,Name:"已核实",Active:!1},{Id:2,Name:"已核实但不存在",Active:!1}],a.selectTab=a.navTabList[0],a.ExtraResourceTypes=[{Checked:!1,Id:1,Name:"无"},{Checked:!1,Id:2,Name:"表单填写"},{Checked:!1,Id:4,Name:"线上民主协商"},{Checked:!1,Id:8,Name:"线下民主协商"},{Checked:!1,Id:16,Name:"线上临时协商"},{Checked:!1,Id:32,Name:"线下临时协商"},{Checked:!1,Id:64,Name:"核实"},{Checked:!1,Id:128,Name:"入库"}],a.NegotiateStates=[{Id:0,Name:"未开始"},{Id:1,Name:"协商中"},{Id:2,Name:"取消"},{Id:3,Name:"结果统计中"},{Id:4,Name:"公示中"},{Id:5,Name:"已完成"}],a.checked=function(b){a.navTabList.forEach(function(a,c){a.Name===b.Name?a.Active=!0:a.Active=!1}),a.selectTab!==b&&(a.selectTab=b,a.fetchData())},a.fetchData=function(){var c={},d="";switch(a.selectTab.Id){case 1:c.history=!1,c.verify=!0,d=g.allWorkers,h.fetchData(a,d,c,b.gHeader);break;case 2:c.history=!1,c.verify=!1,d=g.allWorkers,h.fetchData(a,d,c,b.gHeader);break;case 3:c.mid=l,d=g.demoCratictransactionbymid,h.fetchList(a,d,c,b.gHeader)}};var m=function(a,b){var d,e="";switch(a.ItemContent.FormType){case 1:e="流动人口",a.fields_List=a.fieldsList[1],d=g.getFloating;break;case 2:e="环境卫生",a.fields_List=a.fieldsList[2],d=g.getEnvironmental;break;case 3:e="纠纷调解",a.fields_List=a.fieldsList[3],d=g.getDispute;break;case 4:e="重点人群",a.fields_List=a.fieldsList[4],d=g.getKeypopulation}c({method:"get",url:d+"?id="+a.ItemContent.FormId}).success(function(c){var d=c.State.Code,e=c.State.Message;0===d?(a.ItemContent=c.Content,b.resolve("success")):f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})};a.fetchData();var n=function(a,b){var c={albumid:a.ItemContent.PhotoAlbumId};e.regListSpecifyPage(a,{apiUrl:g.photoitemList,params:c,success:function(c){a.ItemContent.Photoes=c,a.templateName="Photoes",b.resolve("success")},error:function(a){f.autoclose(errorResult(a))}},null)},o=function(a,b){a.listBusyPromise=c({method:"get",url:g.erDemoprojectoffline+"?id="+a.ItemContent.PhotoAlbumId}).success(function(c){var d=c.State.Code,e=c.State.Message;0===d?(a.ItemContent=$.extend(!0,a.ItemContent,c.Content),n(a,b),a.fields_List=a.fieldsList[7]):f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})},p=function(a,b,d){a.listBusyPromise=c({method:"get",url:g.getDate+"?id="+b}).success(function(b){var c=b.State.Code,e=b.State.Message;0===c?(a.ItemContent.SeatAddress=b.Content.GradePathName,d.resolve()):f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})},q=function(a,b,d,e){a.listBusyPromise=c({method:"get",url:g.eventByworkflowerid+"?inspectorId="+b+"&workflowerId="+d}).success(function(b){var c=b.State.Code,d=b.State.Message;if(0===c){var g=b.Content.OccurLocationId;p(a,g,e)}else f.autoclose(d)}).error(function(a){f.autoclose(h.errorResult(a))})},r=function(a,b){a.listBusyPromise=c({method:"get",url:g.demoCratictransaction+"?id="+a.ItemContent.DPId}).success(function(c){var d=c.State.Code,e=c.State.Message;0===d?(a.ItemContent=c.Content,a.fields_List=a.fieldsList[6],b.resolve("success")):f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})};a.detailItem=function(b){a.templateName="createOne",a.fields_List=[];var e,j=i.defer(),k=j.promise,l=i.defer(),n=l.promise;switch(a.selectTab.Id){case 1:a.fields_List=a.fieldsList[0],e="信息核实";break;case 2:e="事项处理",1===b.WorkNodeWorkerType?a.fields_List=a.fieldsList[5]:2===b.WorkNodeWorkerType;break;case 3:a.fields_List=a.fieldsList[7],e="民主协商"}1!==b.ResourceType?a.listBusyPromise=c({method:"get",url:g.erByworkerid+"?workerid="+b.Id}).success(function(c){var d=c.State.Code,g=c.State.Message;if(0===d){var i=c.Content;switch(a.ItemContent=i,a.ItemContent.SeatAddress?l.resolve():q(a,b.NoderWorkflowerInspectorId,b.NoderWorkflowerId,l),b.ResourceType){case 1:break;case 2:e="表单上传",0!==a.ItemContent.FormId?m(a,j):f.autoclose("暂无表单！");break;case 4:e="线上民主协商",0!==a.ItemContent.DPId?r(a,j):f.autoclose("暂无协商项目！");break;case 8:e="线下民主协商",0!==a.ItemContent.PhotoAlbumId?o(a,j):f.autoclose("暂未关联相册！");break;case 16:e="线上临时民主协商",0!==a.ItemContent.DPId?r(a,j):f.autoclose("暂无协商项目！");break;case 32:e="线下临时民主协商",0!==a.ItemContent.PhotoAlbumId?o(a,j):f.autoclose("暂未关联相册！"),j.resolve();break;case 64:e="核实",j.resolve();break;case 128:e="入库",0!==a.ItemContent.FormId?m(a,j):f.autoclose("暂无表单！")}a.ItemContent.ResourceType=h.numberToText(b.ResourceType,a.ExtraResourceTypes);i.State;1===a.selectTab.Id?j.resolve("success"):2===a.selectTab.Id||3===a.selectTab.Id}else f.autoclose(g)}).error(function(a){f.autoclose(h.errorResult(a))}):(a.ItemContent=b,a.fields_List=a.fieldsList[5],j.resolve(),l.resolve()),k.then(function(){var b=a.templateName,c=a.ItemContent;n.then(function(){h.bindFormData(a.ItemContent,a.fields_List);var f=a.fields_List;f.forEach(function(b,c){b.editable=!0,"AuditState"===b.name?b.value=h.numberToText(b.value,a.AuditStates):"VerifyState"===b.name?b.value=h.numberToText(b.value,a.VerifyStates):"NegotiateState"===b.name&&(b.value=h.numberToText(b.value,a.NegotiateStates))}),d.openConfirm({template:b,controller:["$scope",function(a){a.ItemContent=c,a.fieldsList=f,a.TitleText=e,a.preTItie="查看",a.formSubmit=function(){a.closeThisDialog()},a.closeDialog=function(){a.closeThisDialog()}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})})},function(a){console.log(a)},function(a){console.log(a)})},a.AuditStates=[{Id:0,Name:"未审核"},{Id:1,Name:"审核通过"},{Id:2,Name:"审核驳回"}],a.fieldsList=[[{name:"Name",nameDisplay:"名称",editor:"normal",value:"",originValue:"",column:1},{name:"WorkerNoderName",nameDisplay:"节点名称",editor:"normal",value:"",originValue:"",column:1},{name:"VerifyState",nameDisplay:"核实状态",editor:"normal",value:"",originValue:"",column:1},{name:"CreatedAt",nameDisplay:"创建时间",editor:"normal",value:"",originValue:"",column:1},{name:"Description",nameDisplay:"描述",editor:"normal",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置信息",editor:"normal",value:"",originValue:"",column:1}],[{name:"Name",nameDisplay:"名称",editor:"normal",value:"",originValue:"",column:1},{name:"DomicilePlace",nameDisplay:"住所",editor:"normal",value:"",originValue:"",column:1},{name:"IDCardNo",nameDisplay:"身份证号码",editor:"normal",value:"",originValue:"",column:1},{name:"CurrentAddress",nameDisplay:"当前地址",editor:"normal",value:"",originValue:"",column:1},{name:"Phone",nameDisplay:"手机号码",editor:"normal",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置信息",editor:"normal",value:"",originValue:"",column:1}],[{name:"Remarks",nameDisplay:"备注",editor:"normal",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置",editor:"normal",value:"",originValue:"",column:1},{name:"ImagesN",nameDisplay:"照片",editor:"photo",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置信息",editor:"normal",value:"",originValue:"",column:1}],[{name:"Remarks",nameDisplay:"备注",editor:"normal",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置",editor:"normal",value:"",originValue:"",column:1},{name:"ImagesN",nameDisplay:"照片",editor:"normal",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置信息",editor:"normal",value:"",originValue:"",column:1}],[{name:"Name",nameDisplay:"名称",editor:"normal",value:"",originValue:"",column:1},{name:"DomicilePlace",nameDisplay:"住所",editor:"normal",value:"",originValue:"",column:1},{name:"IDCardNo",nameDisplay:"身份证号码",editor:"normal",value:"",originValue:"",column:1},{name:"CurrentAddress",nameDisplay:"当前地址",editor:"normal",value:"",originValue:"",column:1},{name:"Phone",nameDisplay:"手机号码",editor:"normal",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置信息",editor:"normal",value:"",originValue:"",column:1}],[{name:"NoderName",nameDisplay:"节点名称",editor:"normal",value:"",originValue:"",column:1},{name:"WorkName",nameDisplay:"工作者",editor:"normal",value:"",originValue:"",column:1},{name:"AuditState",nameDisplay:"审核状态",editor:"normal",value:"",originValue:"",column:1},{name:"CreatedAt",nameDisplay:"创建时间",editor:"normal",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置信息",editor:"normal",value:"",originValue:"",column:1}],[{name:"Name",nameDisplay:"协商项目",editor:"normal",value:"",originValue:"",column:1},{name:"Description",nameDisplay:"描述",editor:"normal",value:"",originValue:"",column:1},{name:"NegotiateState",nameDisplay:"协商状态",editor:"normal",value:"",originValue:"",column:1},{name:"ValidStartTime",nameDisplay:"有效开始时间",editor:"normal",value:"",originValue:"",column:1},{name:"ValidEndTime",nameDisplay:"有效结束时间",editor:"normal",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置信息",editor:"normal",value:"",originValue:"",column:1}],[{name:"PhotoAlbumName",nameDisplay:"相册名称",editor:"normal",value:"",originValue:"",column:1},{name:"PhotoAlbumName",nameDisplay:"相册名称",editor:"normal",value:"",originValue:"",column:1},{name:"PhotoAlbumName",nameDisplay:"相册名称",editor:"normal",value:"",originValue:"",column:1},{name:"PhotoAlbumName",nameDisplay:"相册名称",editor:"normal",value:"",originValue:"",column:1},{name:"SeatAddress",nameDisplay:"位置信息",editor:"normal",value:"",originValue:"",column:1}]];var s=function(a,b,d,e,i){a.listBusyPromise=c({method:"get",url:g.erResourcebyworkerid+"?workerid="+b}).success(function(a){var b=a.State.Code,c=a.State.Message;if(0===b){var g=a.Content;switch(d){case 2:var h=g.FormId;if(0===h)return void f.autoclose("暂时无法完成该项操作！");finishersFillform(e,h);break;case 4:break;case 8:break;case 16:break;case 32:break;case 64:break;case 128:var i=g.FormId;if(0===i)return void f.autoclose("暂时无法完成该项操作！");finishersStorage(e,h)}}else f.autoclose(c)}).error(function(a){f.autoclose(h.errorResult(a))})},t=function(a,b,d,e,i,j,k){a.listBusyPromise=c({method:"get",url:g.erByworkerid+"?workerid="+b}).success(function(c){var g=c.State.Code,h=c.State.Message;if(0===g){var l=c.Content,m=l.State,n=l.Id;if(k&&(k.resId=n),0===m)switch(d){case 2:s(a,b,d,n,e);break;case 4:break;case 8:break;case 16:break;case 32:break;case 64:s(a,b,d,n,e);break;case 128:s(a,b,d,n,e)}else if(1===m)switch(d){case 2:var o=l.FormId;if(0===o)return void f.autoclose("暂时无法完成该项操作！");finishersFillform(n,o);break;case 4:j=j[0],upDateOnlineDemoproject(l,j);break;case 8:break;case 16:break;case 32:break;case 64:break;case 128:var p=l.FormId;if(0===p)return void f.autoclose("暂时无法完成该项操作！");finishersStorage(n,p)}else 2===m?(4===d&&(j=j[1]),getNextNoders(a,i,j,e)):e.resolve("success")}else f.autoclose(h)}).error(function(a){f.autoclose(h.errorResult(a))})};a.editItem=function(c){var e,f,j,k=i.defer(),l=k.promise,m=600,o=null,p=!0,q="",r=a.fetchData;switch(c.WorkNodeWorkerType){case 1:switch(f="审核",p=!1,j=g.workerAudit+"?nextNoderId=",c.AuditState){case 0:e=a.fieldsList[0][0],q="_createOne";break;case 1:e=a.fieldsList[0][1],q="createOne";break;case 2:}getNextNoders(a,c.NoderId,e,k);break;case 2:p=!1,e=a.fieldsList[1][0];var s=c.WorkExtraResource,u=[];if(a.ExtraResourceTypes.forEach(function(a,b){(a.Id&s)===a.Id&&u.push(a)}),1!==u.length)checkmyNextStep(c,u,a,k,e,a.fieldsList,q);else switch(s){case 1:j=g.workerBlank+"?nextNoderId=",f="普通（无）",e=a.fieldsList[1][0],q="createOne",getNextNoders(a,c.NoderId,e,k);break;case 2:j=g.workerBlank+"?nextNoderId=",f="表单填写",e=a.fieldsList[1][0],q="_createOne",t(a,c.Id,c.ResourceType,k,c.NoderId,e);break;case 4:j=g.finisherDponline,f="线上民主协商",e=a.fieldsList[1],q="createOne",t(a,c.Id,c.ResourceType,k,c.NoderId,e,c);break;case 8:j=g.erResourcebyworkerid+"?workerid="+c.Id,f="线下民主协商",e=a.fieldsList[1][3],q="listOne",m=850,k.resolve("success");break;case 16:j=g.erResourcebyworkerid+"?workerid="+c.Id,f="线上临时民主协商",e=a.fieldsList[1][4],q="createOne",t(a,c.Id,c.ResourceType,k);break;case 32:j=g.erResourcebyworkerid+"?workerid="+c.Id,f="线下临时民主协商无",e=a.fieldsList[1][5],q="createOne",t(a,c.Id,c.ResourceType,k);break;case 64:j=g.erResourcebyworkerid+"?workerid="+c.Id,f="核实",e=a.fieldsList[1][6],q="createOne",t(a,c.Id,c.ResourceType,k);break;case 128:j=g.erResourcebyworkerid+"?workerid="+c.Id,f="入库",e=a.fieldsList[1][7],q="createOne",t(a,c.Id,c.ResourceType,k)}}l.then(function(g){h.initFormList(e);var i=a.DemocraticProjects;d.openConfirm({template:q,controller:["$scope",function(a){a.fetchData=r,a.preTItie=f,a.TitleText="事项处理",a.fieldsList=e,a.Photoes=[],2===c.WorkNodeWorkerType&&4===c.ResourceType&&(a.DemocraticProjects=i),2===c.WorkNodeWorkerType&&8===c.ResourceType&&(a.TitleName="相册",a.getPhotoes=function(a,b){n(a,b)},a.AlbumManage=function(a){d.openConfirm({template:"listOne",controller:["$scope",function(b){b.TitleText="照片",b.preTItie="管理",b.TitleName="照片",getItPhotoes(b,a),b.createAlbum=function(){var c=b;d.openConfirm({template:"createOne",controller:["$scope",function(b){b.fieldsList=[{name:"PhotoUrl",nameDisplay:"选择照片",editor:"file-upload",required:!0,value:""},{name:"Name",nameDisplay:"名称",editor:"normal",required:!1,value:""},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:""},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:""}],b.TitleText="新增",b.preTItie="照片",b.formSubmit=function(){addNewPhotoes(c,b,b.fieldsList,a)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},b.deleteAlbum=function(a){deleteAlbum(b,a,!0)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},a.deleteAlbum=function(b){deleteAlbum(a,b)},a.getPhotoes(a,k),a.editAlbum=function(b){var c=a;d.openConfirm({template:"createOne",controller:["$scope",function(a){a.fieldsList=[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:"",column:1},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:"",column:1},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:"",column:1}],h.bindFormData(b,a.fieldsList),a.TitleText="修改",a.preTItie="相册",a.formSubmit=function(){addNewAlbum(c,a,!1,a.fieldsList,b)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},a.createAlbum=function(){var b=a;d.openConfirm({template:"createOne",controller:["$scope",function(a){a.fieldsList=[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:"",column:1},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:"",column:1},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:"",column:1}],a.TitleText="新增",a.preTItie="相册",a.formSubmit=function(){addNewAlbum(b,a,!0,a.fieldsList)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})}),a.closeDialog=function(){d.closeAll()},a.formSubmit=function(){var d;switch(c.WorkNodeWorkerType){case 1:switch(o={Id:c.Id},h.getFormData(a.fieldsList).nextNoderId?d=h.getFormData(a.fieldsList).nextNoderId:o.nextNoderId=0,j+=d,c.AuditState){case 0:break;case 1:o.AuditState=c.AuditState;break;case 2:}break;case 2:switch(o={Id:c.Id},c.ResourceType){case 1:d=h.getFormData(a.fieldsList).nextNoderId,d||(d=0),j+=d;break;case 2:d=h.getFormData(a.fieldsList).nextNoderId,d||(d=0),j+=d;break;case 4:var e=h.getFormData(a.fieldsList).dpid,f="";a.DemocraticProjects.length>0&&a.DemocraticProjects.forEach(function(a,b){a.Id===e&&(f=a.Name)});var g=c.resId?c.resId:0;finisherDponline(a,g,e,f);break;case 8:break;case 16:break;case 32:break;case 64:break;case 128:}}h.formSubmit(a,p,a.fieldsList,j,null,o,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:m})},function(a){},function(a){})}}]);