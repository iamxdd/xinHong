/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("yuangongguanliCtrl",["$scope","$http","ngDialog","PagerExtends","layerAlert","serverUrls","$filter","PcService",function(a,b,c,d,e,f,g,h){a.list=[],a.TitleText="新增",a.searchOption={name:""},a.department=[{Id:0,Name:"请选择"}],a.workfields=[{keyId:""},{nameDisplay:"发表时间",name:"startTimeAndendTime",name1:"startTime",name2:"endTime",value1:g("date")(new Date,"yyyy-MM-dd 00:00"),value2:g("date")(new Date,"yyyy-MM-dd 23:59"),editor:"double-datePick"}];var i=function(a,b,c){b.forEach(function(b,d){b.name===a&&(b.opts=c,b.originValue=c[0].Id)})};a.configItem=function(d){var g=a.fetchData;c.openConfirm({template:"configOne",controller:["$scope",function(a){a.fetchData=g,a.fieldsList=[{name:"phone",nameDisplay:"电话号码",editor:"normal",required:!0,value:""}],a.formSubmit=function(){a.ngDialogPromise=b({method:"get",url:f.allOcationf+"?personnelid="+d.Id+"&phone="+a.fieldsList[0].value}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(e.autoclose("分配成功!"),setTimeout(function(){a.fetchData()},1600)):e.autoclose(d)}).error(function(a){e.autoclose(h.errorResult(a))})}}],className:"ngdialog-theme-default",closeByEscape:!0,closeByDocument:!1,width:600})};var j=new Array("日","一","二","三","四","五","六"),k=function(a){var b=new Date(a);return"星期"+j[b.getDay()]},l=function(b){d.regListSpecifyPage(a,{apiUrl:f.workinggtrajectoryList,params:b,success:function(b){a.new_list=b,0!==a.new_list.length&&a.new_list.map(function(a){a.weekDay=k(new Date(a.UploadAt))})},error:function(a){e.autoclose(a)}})};a.workingList=function(b){var d={startTime:a.workfields[1].value1,endTime:a.workfields[1].value2,empon:b.Empno};a.workfields[0].keyId=b.Empno,l(d),c.openConfirm({template:"workList",scope:a,controller:["$scope",function(a){a.TitleText=b.Name,a.workListSure=function(){var b={startTime:a.workfields[1].value1,endTime:a.workfields[1].value2,empon:a.workfields[0].keyId};l(b)}}],className:"ngdialog-theme-default",closeByEscape:!0,closeByDocument:!1,width:700}),setTimeout(function(){$("#datetimeStart").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,forceParse:0,format:"yyyy-mm-dd hh:ii",showMeridian:1}).on("click",function(a){$("#datetimeStart").datetimepicker()}),$("#datetimeEnd").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,forceParse:0,format:"yyyy-mm-dd hh:ii",showMeridian:1}).on("click",function(a){$("#datetimeEnd").datetimepicker()})},20)};var m=function(a,c){b({method:"get",url:f.organizationAll+"?state="+a}).success(function(a){var b=a.State.Code,d=a.State.Message;if(0===b){var f=a.Content;i("OrganizationsId",c,f)}else e.autoclose(d)}).error(function(a){e.autoclose(h.errorResult(a))})};a.stations=[{Id:0,Name:"请选择"}];var n=function(a,c){b({method:"get",url:f.positionAll+"?state="+a}).success(function(a){var b=a.State.Code,d=a.State.Message;if(0===b){var f=a.Content;i("PositionId",c,f)}else e.autoclose(d)}).error(function(a){e.autoclose(h.errorResult(a))})},o=function(a){var b={};return a.forEach(function(a,c){"four-select"===a.editor?b[a.name]=a.value4:b[a.name]=a.value}),b},p=function(d,g,i){var j,k,l,m=o(g);d?(j="新增",l="post",k=f.addPersonnel):(j="修改",l="put",k=f.upPersonnel,m.Id=i),a.ngDialogPromise=b({method:l,url:k,data:m}).success(function(b){var d=b.State.Code,f=b.State.Message;0===d?(e.autoclose(j+"操作成功！"),a.fetchData(),setTimeout(function(){c.closeAll()},1600)):e.autoclose(f)}).error(function(a){e.autoclose(h.errorResult(a))})},q=function(a){a.forEach(function(a,b){a.value=a.originValue})},r=function(a,c,d){a.ngDialogPromise=b({method:"get",url:f.getIdcardno+"?idcardno="+d}).success(function(a){var b=a.State.Code,d=a.State.Message;if(0===b){var f=a.Content;if(!f)return e.autoclose("该身份证号下无相关居民!"),void h.initFormList(c);f.Id&&delete f.Id,h.bindFormData(f,c)}else h.initFormList(c),e.autoclose(d)}).error(function(a){h.initFormList(c),e.autoclose(h.errorResult(a))})};a.creatOne=function(){fieldsList=a.fieldsList,q(fieldsList),c.openConfirm({template:"createOne",controller:["$scope",function(a){a.fieldsList=fieldsList,a.TitleText="新增",a.IDCardNo="",a.create=!0;a.formSubmit=function(){p(!0,a.fieldsList)},a.getMoreInfo=function(b){b&&r(a,a.fieldsList,b)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})};var s=function(a,b){b.forEach(function(b,c){b.value=a[b.name]?a[b.name]:""})};a.editItem=function(b){var d=a.fieldsList;s(b,d),c.openConfirm({template:"createOne",controller:["$scope",function(a){a.fieldsList=d,a.TitleText="修改",a.create=!1,a.formSubmit=function(){p(!1,a.fieldsList,b.Id)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},a.toggleText=function(a){var b;switch(a.OpenState){case 2:b="启用";break;case 1:b="停用";break;default:b="无"}return b},a.toggleClass=function(a){var b={"btn-success":2===a.OpenState,"btn-danger":1===a.OpenState};return b},a.toggleItem=function(b){h.toggleItem(a,b,f.personnelState)},a.fetchData=function(){d.regListSpecifyPage(a,{apiUrl:f.personnelList,params:a.searchOption,success:function(b){(0===a.stations.length||1===a.stations.length&&0===a.stations[0].Id)&&n(0,a.fieldsList),(0===a.department.length||1===a.department.length&&0===a.stations[0].Id)&&m(0,a.fieldsList),a.list=b},error:function(a){e.autoclose(a)}})},a.fetchData(),a.gender=[{Id:1,Name:"男"},{Id:2,Name:"女"}],a.employeeTypes=[{Id:1,Name:"区域管理员"},{Id:2,Name:"普通员工"}],a.numberTOText=function(a,b){var c;return b.forEach(function(b,d){b.Id===a&&(c=b.Name)}),c},a.fieldsList=[{name:"Empno",nameDisplay:"编号",editor:"normal",required:!0,value:"",originValue:""},{name:"IDCardNo",nameDisplay:"身份证号码",editor:"normal",required:!0,value:"",originValue:"",editable:!0},{name:"Name",nameDisplay:"姓名",editor:"normal",required:!0,value:"",originValue:"",editable:!0},{name:"PositionId",nameDisplay:"岗位",editor:"select",required:!1,value:"",opts:a.stations,originValue:a.stations[0].Id},{name:"Sex",nameDisplay:"性别",editor:"select",required:!1,value:"",opts:a.gender,originValue:a.gender[0].Id,editable:!0},{name:"OrganizationsId",nameDisplay:"所属部门",editor:"select",required:!1,value:"",opts:a.department,originValue:a.department[0].Id},{name:"Telephone",nameDisplay:"联系电话",editor:"normal",required:!1,value:"",originValue:""},{name:"Sort",nameDisplay:"排序号",editor:"normal",required:!1,value:"",originValue:0},{name:"Remark",nameDisplay:"备注",editor:"normal",required:!1,value:"",originValue:""},{name:"Email",nameDisplay:"邮箱",editor:"normal",required:!1,value:"",originValue:""}]}]);