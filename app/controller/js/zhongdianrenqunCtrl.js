/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("zhongdianrenqunCtrl",["$scope","$rootScope","$http","ngDialog","PagerExtends","layerAlert","$timeout","serverUrls","PcService",function(a,b,c,d,e,f,g,h,i){a.list=[],a.TitleText="新增",a.PcService=i,a.courtyard=a.banlist=a.units=a.roomNumber=initArray=[{Id:0,Name:"请选择"}],a.ResidentList=a.UnitList=a.BuildingList=a.HouseList=[],a.searchOption={type:1};var j=function(a,b,c,d){b.forEach(function(b,e){b.name===a&&(b.opts=c,d?b.value=d:b.value=c[0]?c[0].Id:"")})},k=function(){a.ngDialogPromise=c({method:"get",url:h.courtyardAll}).success(function(b){var c=b.State.Code,d=b.State.Message;if(0===c){var e=initArray.concat(b.Content);a.courtyard=e,j("CourtyardId",a.fieldsList[0],e)}else f.autoclose(d)}).error(function(a){f.autoclose(i.errorResult(a))})},l=function(b,d,e){a.ngDialogPromise=c({method:"get",url:h.buildingAll+"?id="+b+"&type="+d}).success(function(b){var c=b.State.Code,g=b.State.Message;if(0===c){var h=initArray.concat(b.Content),i=0===h.length||1===h.length&&0===h[0].Id;switch(d){case 1:i?j("BuildingId",e,initArray):j("BuildingId",e,h),a.BuildingList=h,e.forEach(function(b,c){return"BuildingId"===b.name?void(b.opts=a.BuildingList):void 0}),j("UnitId",e,initArray),j("HouseId",e,initArray),j("ResidentId",e,initArray);break;case 2:i?j("UnitId",e,initArray):j("UnitId",e,h),a.UnitList=h,j("HouseId",e,initArray),j("ResidentId",e,initArray);break;case 3:break;case 4:}}else f.autoclose(g)}).error(function(a){f.autoclose(i.errorResult(a))})},m=function(b,d,e){a.ngDialogPromise=c({method:"get",url:h.houseResident+"?id="+d}).success(function(a){var c=a.State.Code,d=a.State.Message;if(0===c){if(0===a.Content.length)return void f.autoclose("该房号下暂无可选人员,请选择其他房号.");var g=initArray.concat(a.Content);j(b,e,g)}else f.autoclose(d)}).error(function(a){f.autoclose(i.errorResult(a))})},n=function(b,d){a.ngDialogPromise=c({method:"get",url:h.unitHouseList+"?id="+b}).success(function(b){var c=b.State.Code,e=b.State.Message;if(0===c){a.HouseList=b.Content,a.HouseList.forEach(function(a,b){a.Name=a.RoomNumber});var g=initArray.concat(b.Content);j("HouseId",d,g)}else f.autoclose(e)}).error(function(a){f.autoclose(i.errorResult(a))})},o=function(b){switch(b.name){case"CourtyardId":l(b.value,1,a.fieldsList[0]);break;case"BuildingId":l(b.value,2,a.fieldsList[0]);break;case"UnitId":n(b.value,a.fieldsList[0]);break;case"HouseId":m("ResidentId",b.value,a.fieldsList[0])}},p=function(a){var b={};return a.forEach(function(a,c){if("multiselect"===a.editor){var d="";a.opts.forEach(function(a,b){a.Checked&&(d+=a.Id+",")}),d=d.substring(0,d.length-1),b[a.name]=d}else b[a.name]=a.value}),b},q=function(e,g,j){var k=p(g),l={};l.PopulationType=k.PopulationType,l.ResidentId=k.ResidentId;var m,n,o;switch(e){case!0:m="put",n=h.addKeypopulation,o="新增";break;case!1:m="put",n=h.addKeypopulation,o="修改"}a.ngDialogPromise=c({headers:b.pHeader,method:m,url:n,data:l}).success(function(b){var c=b.State.Code,e=b.State.Message;0===c?(f.autoclose(o+"操作成功!"),setTimeout(function(){d.closeAll()},1600),a.fetchData()):f.autoclose(e)}).error(function(a){f.autoclose(i.errorResult(a))})};a.creatOne=function(){a.fieldsList.forEach(function(a,b){a.editable=!1});var b=a.fieldsList[0];i.initFormList(b),d.openConfirm({template:"createOne",controller:["$scope",function(a){a.fieldsList=b,a.TitleText="新增",a.creating=!0,a.formSubmit=function(){q(!0,a.fieldsList)},a.closeDialog=function(a){d.close(a)},a.fieldChange=o}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},a.Nations=[{Id:0,Name:"全部"},{Id:1,Name:"汉族"},{Id:2,Name:"藏族"},{Id:3,Name:"彝族"},{Id:4,Name:"其他少数民族"}],a.Sexes=[{Id:0,Name:"全部"},{Id:1,Name:"男"},{Id:2,Name:"女"}],a.Crowd=[{nameDisplay:"孤寡老人",value:1,Checked:!1},{nameDisplay:"残疾人",value:2,Checked:!1},{nameDisplay:"高龄老人",value:3,Checked:!1},{nameDisplay:"低保户",value:4,Checked:!1},{nameDisplay:"失独老人",value:5,Checked:!1},{nameDisplay:"吸毒人群",value:6,Checked:!1},{nameDisplay:"劳改刑满释放人员",value:7,Checked:!1},{nameDisplay:"社区矫正人员",value:8,Checked:!1},{nameDisplay:"其他人员",value:9,Checked:!1}],a.screenfields=[{nameDisplay:"关键字",name:"name",value:"",editor:"normal"},{nameDisplay:"性别",name:"sex",value:a.Sexes[0].Id,editor:"select",opts:a.Sexes},{nameDisplay:"民族",name:"nationality",value:a.Nations[0].Id,editor:"select",opts:a.Nations}],a.Names=[{Id:0,Name:"请选择"}],a.PeopleType=[{Name:"孤寡老人",Id:1},{Name:"残疾人",Id:2},{Name:"高龄老人",Id:3},{Name:"低保户",Id:4},{Name:"失独老人",Id:5},{Name:"吸毒人群",Id:6},{Name:"劳改刑满释放人员",Id:7},{Name:"社区矫正人员",Id:8},{Name:"其他人员",Id:9}],a.fieldsList=[[{name:"CourtyardId",nameDisplay:"院落",editor:"select",required:!0,value:"",opts:a.courtyard,originValue:a.courtyard[0].Id},{name:"BuildingId",nameDisplay:"楼栋",editor:"select",required:!0,value:"",opts:a.banlist,originValue:a.banlist[0].Id},{name:"UnitId",nameDisplay:"单元",editor:"select",required:!0,value:"",opts:a.units,originValue:a.units[0].Id},{name:"HouseId",nameDisplay:"房号",editor:"select",required:!0,value:"",opts:a.roomNumber,originValue:a.roomNumber[0].Id},{name:"ResidentId",nameDisplay:"人员姓名",editor:"select",required:!0,value:"",opts:a.Names,originValue:a.Names[0].Id},{name:"PopulationType",nameDisplay:"人员类型",editor:"multiselect",required:!0,value:"",opts:a.PeopleType,originValue:a.PeopleType[0].Id,column:1}],[{name:"ResidentName",nameDisplay:"姓名",editor:"normal",required:!0,value:""},{name:"ResidentSex",nameDisplay:"性别",editor:"normal",required:!0,value:""},{name:"ResidentBirthDate",nameDisplay:"生日",editor:"normal",required:!0,value:""},{name:"ResidentNationality",nameDisplay:"民族",editor:"normal",required:!0,value:""},{name:"ResidentPhone",nameDisplay:"电话号码",editor:"normal",required:!0,value:""},{name:"PopulationType",nameDisplay:"人员类型",editor:"normal",required:!0,value:"",column:1}]],a.getFetchData=function(){var b={};return a.screenfields.forEach(function(a,c){b[a.name]=a.value}),b},a.fetchData=function(){var b="";a.Crowd.forEach(function(a,c){a.Checked&&(b+=a.value+",")}),b=b.substring(0,b.length-1),a.searchOption.type=b;var c=$.extend(!0,a.searchOption,a.getFetchData());e.regListSpecifyPage(a,{apiUrl:h.keypopulationList,params:c,success:function(b){a.list=b;var c=new Date;a.list.length>0&&a.list.forEach(function(a,b){a.Age=(c-new Date(a.ResidentBirthDate))/31536e6,a.Age>150?a.Age="无":a.Age<1?a.Age=Math.ceil(12*a.Age)+"月":a.Age>=1&&(a.Age=Math.floor(a.Age)+"岁")}),k()},error:function(a){f.autoclose(a)}})},a.fetchData();var r=function(a){d.openConfirm({template:"createOne",controller:["$scope",function(b){b.fieldsList=a,b.TitleText="查看",b.creating=!1,b.formSubmit=function(){d.closeAll()},b.closeDialog=function(){d.closeAll()},b.fieldChange=o}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},s=function(a,b){var c;return b.forEach(function(b,d){b.value===a&&(c=b.nameDisplay)}),c},t=function(b,c){c.forEach(function(c,d){void 0!==b[c.name]&&("PopulationType"===c.name?c.value=s(b[c.name],a.Crowd):"ResidentSex"===c.name?c.value=i.numberToText(b[c.name],a.Sexes):"ResidentNationality"===c.name?c.value=i.numberToText(b[c.name],a.Nations):c.value=b[c.name])})};a.editItem=function(b){var c=a.fieldsList[1];t(b,c),r(c)}}]);