/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("cheliangguanliCtrl",["$scope","$http","ngDialog","PagerExtends","layerAlert","serverUrls","PcService",function(a,b,c,d,e,f,g){a.list=[],a.TitleText="新增",a.searchOption={plateNumber:"",openstate:0},a.PcService=g,a.VehicleBrands=[],a.VehicleModels=[{Id:"两厢轿车",Name:"两厢轿车"},{Id:"三厢轿车",Name:"三厢轿车"},{Id:"跑车",Name:"跑车"},{Id:"SUV",Name:"SUV"},{Id:"MPV",Name:"MPV"},{Id:"面包车",Name:"面包车"},{Id:"皮卡车",Name:"皮卡车"}],a.PcService=g,a.CourtyardList=a.BuildingList=a.UnitList=a.FloorList=a.HouseList=[{Id:0,Name:"请选择"}];var h=function(a){var b={};return a.forEach(function(a,c){"four-select"===a.editor?b[a.name]=a.value4:b[a.name]=a.value}),b},i=function(d,i,j){var k=h(i),l=k.PlateNumber;if(!g.isPlateNumber(l)&&l)return void e.autoclose("车牌号输入不正确！");var m,n,o;d?(m="新增",o="post",n=f.addVehicle):(m="修改",o="put",n=f.upVehicle,k.Id=j),a.ngDialogPromise=b({method:o,url:n,data:k}).success(function(b){var d=b.State.Code,f=b.State.Message;0===d?(e.autoclose(m+"操作成功！"),a.fetchData(),setTimeout(function(){c.closeAll()},1600)):e.autoclose(f)}).error(function(a){e.autoclose(g.errorResult(a))})},j=function(b){b.forEach(function(b,c){"four-select"===b.editor&&(b.value1=a.CourtyardList[0].Id,b.value2=a.BuildingList[0].Id,b.value3=a.UnitList[0].Id,b.value4=a.HouseList[0].Id,b.opts1=a.CourtyardList,b.opts2=a.BuildingList,b.opts3=a.UnitList,b.opts4=a.HouseList)})},k=function(a){a.forEach(function(a,b){"four-select"===a.editor?a.value4=a.originValue:a.value=a.originValue})};a.creatOne=function(){var b=a.fieldsList;j(b),c.openConfirm({template:"createOne",controller:["$scope",function(a){a.TitleText="新增",a.fieldsList=b,k(a.fieldsList),a.formSubmit=function(){i(!0,a.fieldsList)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})};var l=function(c,d){a.ngDialogPromise=b({method:"get",url:f.getSuperior+"?id="+c+"&type=4"}).success(function(a){var b=a.State.Code,f=a.State.Message;if(0===b){var g=a.Content,h=g.CourtyardId,i=g.BuildingId,j=g.UnitId;g.FloorId;d.value1=h,d.opts1.forEach(function(a,b){a.Location.forEach(function(b,e){b.Id===i&&(d.opts2=a.Location,d.value2=i,d.opts2.forEach(function(a,b){a.Location.forEach(function(b,e){b.Id===j&&(d.opts3=a.Location,d.value3=j,d.opts3.forEach(function(a,b){a.Location.forEach(function(b,e){b.Id===c&&(d.opts4=a.Location,d.value4=c)})}))})}))})})}else e.autoclose(f)}).error(function(a){e.autoclose(g.errorResult(a))})},m=function(a,b){c.openConfirm({template:"createOne",controller:["$scope",function(c){c.TitleText="修改",c.fieldsList=b,c.formSubmit=function(){i(!1,c.fieldsList,a.Id)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},n=function(c,d,h){a.ngDialogPromise=b({method:"get",url:f.houseResident+"?id="+c}).success(function(b){var c=b.State.Code,f=b.State.Message;0===c?(a.residentList=b.Content,d.forEach(function(b,c){"ResidentId"===b.name&&(b.opts=a.residentList,m(h,d))})):e.autoclose(f)}).error(function(a){e.autoclose(g.errorResult(a))})},o=function(a,b){var c;b.forEach(function(d,e){"HouseId"===d.name?(d.value4=a[d.name]?a[d.name]:"",c=d.value4,l(c,d)):"ResidentId"===d.name?(d.value=a[d.name]?a[d.name]:"",n(a.HouseId,b,a)):d.value=a[d.name]?a[d.name]:""})};a.editItem=function(b){var c=a.fieldsList;j(c),o(b,c)},a.colorList=[{Id:1,Name:"白色"},{Id:2,Name:"灰色"},{Id:3,Name:"黄色"},{Id:4,Name:"粉色"},{Id:5,Name:"红色"},{Id:6,Name:"紫色"},{Id:7,Name:"绿色"},{Id:8,Name:"蓝色"},{Id:9,Name:"棕色"},{Id:10,Name:"黑色"}];var p=function(){a.listBusyPromise=b({method:"get",url:f.courtyardAllList}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(a.CourtyardList=b.Content,a.CourtyardList.forEach(function(a,b){a.Location.forEach(function(a,b){a.Location.forEach(function(a,b){var c=[];a.Location.forEach(function(a,b){c=c.concat(a.Location)}),a.Location=c})})}),a.BuildingList=a.BuildingList.concat(a.CourtyardList[0].Location),a.UnitList=a.UnitList.concat(a.BuildingList[1].Location),a.HouseList=a.HouseList.concat(a.UnitList[0].Location)):e.autoclose(d)}).error(function(a){e.autoclose(g.errorResult(a))})};a.fieldsList=[{name:"HouseId",nameDisplay:"房屋信息",editor:"four-select",required:!0,opts1:a.CourtyardList,opts2:a.BuildingList,opts3:a.UnitList,opts4:a.HouseList,value1:"",value2:"",value3:"",value4:"",column:1,originValue:0,getResident:!0},{name:"ResidentId",nameDisplay:"车主姓名",editor:"search-select",required:!0,value:"",originValue:1,opts:""},{name:"VehicleType",nameDisplay:"车辆类型",editor:"select",required:!1,value:"",originValue:"两厢轿车",opts:a.VehicleModels},{name:"Color",nameDisplay:"颜色",editor:"select",required:!1,value:"",originValue:1,opts:a.colorList},{name:"VehicleBrand",nameDisplay:"车辆品牌",editor:"select",required:!1,value:"",originValue:"",opts:a.VehicleBrands},{name:"VehicleModel",nameDisplay:"车辆型号",editor:"normal",required:!1,value:"",originValue:"",opts:a.VehicleTypes},{editor:"plate-number",name:"PlateNumber",nameDisplay:"车牌号",required:!0,value:"",originValue:"",noteValue:"地区+6位大写字母/数字"},{name:"ParkingSpaceNo",nameDisplay:"车位号",editor:"normal",required:!1,value:"",originValue:""},{name:"SecondTelephon",nameDisplay:"备用电话",editor:"normal",required:!1,value:"",originValue:""}],a.Status=[{Id:1,Name:"启用中"},{Id:2,Name:"停用中"}],a.toggleItem=function(b){g.toggleItem(a,b,f.vehicleState)};var q=function(a,c){b({method:"get",url:"server/xCar.json"}).success(function(b){a.VehicleBrands=b,a.VehicleBrands.forEach(function(a,b){a.Id=a.Name}),a.fieldsList.forEach(function(b,c){return"VehicleBrand"===b.name?(b.opts=a.VehicleBrands,void(b.originValue=a.VehicleBrands[0].Id)):void 0})}).error(function(a){e.autoclose(g.errorResult(a))})};a.fetchData=function(){g.fetchData(a,f.vehiclelist,a.searchOption),q(a),p()},a.fetchData()}]);