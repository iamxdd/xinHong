/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("daibanshixiangCtrl",["$scope","$rootScope","$http","ngDialog","PagerExtends","layerAlert","serverUrls","PcService","$q",function(a,b,c,d,e,f,g,h,i){a.list=[],a.NextNoders=[],a.DemocraticProjects=[],a.Photoes=[],a.PcService=h,a.navTabList=[{Id:1,Name:"待处理",Active:!0},{Id:2,Name:"历史记录",Active:!1}],a.ifNodeWorkerType=function(a,b){var c=!0;return a.forEach(function(a,d){return a.WorkNodeWorkerType===b?void(c=!1):void 0}),c},a.selectTab=a.navTabList[0],a.seeFieldsList=[{name:"WorkName",nameDisplay:"工作名称",editor:"normal",required:!0,value:""},{name:"CreatedAt",nameDisplay:"创建时间",editor:"textarea",required:!1,value:""},{name:"FormType",nameDisplay:"表单类型",editor:"textarea",required:!1,value:""},{name:"UpdatedAt",nameDisplay:"更新时间",editor:"textarea",required:!1,value:""},{name:"FormUploaderId",nameDisplay:"表单上传者",editor:"textarea",required:!1,value:""},{name:"UnHandle",nameDisplay:"无法处理",editor:"textarea",required:!1,value:""}],a.checked=function(b){a.navTabList.forEach(function(a,c){a.Name===b.Name?a.Active=!0:a.Active=!1}),a.selectTab!==b&&(a.selectTab=b,a.fetchData())},a.fetchData=function(){var c={currentPage:1,length:9999,verify:!1},d="";switch(a.selectTab.Id){case 1:c.history=!1,d=g.myWorkers;break;case 2:c.history=!0,d=g.myWorkers}h.fetchData(a,d,c,b.gHeader)},a.fetchData(),a.ExpectForms=[{Id:0,Name:"流动人口"},{Id:1,Name:"环境卫生"},{Id:2,Name:"纠纷调解"},{Id:3,Name:"重点人群"}],a.Sexes=[{Id:0,Name:"全部"},{Id:1,Name:"男"},{Id:2,Name:"女"}],a.Nations=[{Id:0,Name:"全部"},{Id:1,Name:"汉族"},{Id:2,Name:"藏族"},{Id:3,Name:"彝族"},{Id:3,Name:"其他少数民族"}],a.ResidencePermit=[{Id:0,Name:"全部"},{Id:1,Name:"有"},{Id:2,Name:"无"}],a.SocialSecurityStatus=[{Id:0,Name:"全部"},{Id:1,Name:"有"},{Id:2,Name:"无"}],a.MaritalStatus=[{Id:0,Name:"全部"},{Id:1,Name:"未婚"},{Id:2,Name:"已婚"},{Id:3,Name:"离异"},{Id:4,Name:"丧偶"}],a.PeopleType=[{Name:"孤寡老人",Id:1},{Name:"残疾人",Id:2},{Name:"高龄老人",Id:3},{Name:"低保户",Id:4},{Name:"失独老人",Id:5},{Name:"吸毒人群",Id:6},{Name:"劳改刑满释放人员",Id:7},{Name:"社区矫正人员",Id:8},{Name:"其他人员",Id:9}];var j=function(a,b,d,e){a.ngDialogPromise=c({method:"get",url:g.nextNoders+"?noderid="+b}).success(function(b){var c=b.State.Code,g=b.State.Message;if(0===c){var h=b.Content;d=a.fieldsList[0][1],0!==h.length?d.forEach(function(a,b){"nextNoderId"===a.name&&(a.opts=h,a.originValue=h[0].Id)}):d.forEach(function(a,b){"nextNoderId"===a.name&&(a.opts=[{Id:0,Name:"无下一节点"}],a.originValue=0)}),a.NextNoders=b.Content,e&&e.resolve("success")}else f.autoclose(g)}).error(function(a){f.autoclose(h.errorResult(a))})};a.fieldsList=[[[{name:"AuditState",nameDisplay:"审核结果",editor:"select",required:!1,value:"",column:1,opts:[{Id:1,Name:"审核通过"},{Id:2,Name:"审核驳回"}],originValue:1,changeListen:function(a,b){var c=a.$parent.$parent;2===b?c.fieldsList[1].ifHave=!0:c.fieldsList[1].ifHave=!1}},{name:"nextNoderId",nameDisplay:"下一节点",editor:"select",required:!0,value:"",originValue:"",opts:a.NextNoders,column:1}],[{name:"nextNoderId",nameDisplay:"下一节点",editor:"select",required:!0,value:"",originValue:"",opts:a.nextNoderIds,column:1}]],[[{name:"nextNoderId",nameDisplay:"下一节点",editor:"select",required:!0,value:"",originValue:"",opts:a.nextNoderIds,column:1}],[{name:"dpid",nameDisplay:"协商项目",editor:"select",required:!0,value:"",originValue:"",opts:a.nextNoderIds,column:1}],[{name:"Name",nameDisplay:"协商议题",editor:"text",required:!0,value:""}],[{name:"Summary",nameDisplay:"上报总结",editor:"textarea",required:!0,value:""},{name:"ImagesT",nameDisplay:"图片",editor:"normal",required:!0,value:""}],[{name:"Summary",nameDisplay:"上报总结",editor:"textarea",required:!0,value:""}],[{name:"Name",nameDisplay:"姓名",editor:"normal",required:!0,value:"",originValue:""},{name:"PopulationType",nameDisplay:"人员类型",editor:"select",required:!0,value:"",opts:a.PeopleType,originValue:a.PeopleType[0].Id},{name:"Sex",nameDisplay:"性别",editor:"select",required:!0,value:"",opts:a.Sexes,originValue:a.Sexes[0].Id},{name:"IDCardNo",nameDisplay:"身份证",editor:"normal",required:!0,value:"",originValue:""},{name:"Nationality",nameDisplay:"民族",editor:"select",required:!1,value:"",opts:a.Nations,originValue:a.Nations[0].Id},{name:"DomicilePlace",nameDisplay:"户籍所在地",editor:"normal",required:!1,value:"",originValue:""},{name:"Phone",nameDisplay:"联系电话",editor:"normal",required:!1,value:"",originValue:""},{name:"CurrentAddress",nameDisplay:"现居住地",editor:"normal",required:!1,value:"",originValue:""},{name:"ResidencePermit",nameDisplay:"居住证",editor:"select",required:!1,value:"",opts:a.ResidencePermit,originValue:a.ResidencePermit[0].Id},{name:"SocialSecurity",nameDisplay:"社保状态",editor:"select",required:!1,value:"",opts:a.SocialSecurityStatus,originValue:a.SocialSecurityStatus[0].Id},{name:"MaritalStatus",nameDisplay:"婚姻状态",editor:"select",required:!1,value:"",opts:a.MaritalStatus,originValue:a.MaritalStatus[0].Id}]],[{name:"DemocraticProjectId",nameDisplay:"协商项目",editor:"select",required:!1,value:"",column:1}],[{name:"VerifyState",nameDisplay:"核实结果",editor:"select",required:!1,value:"",column:1,opts:[{Id:1,Name:"已核实事件属实"},{Id:2,Name:"已核实单事件不属实"}],originValue:1}],[]];var k=function(d,e,i,j){a.ngDialogPromise=c({headers:b.gHeader,method:"get",url:g.finisherDponline+"?erid="+e+"&dpid="+i+"&dpname="+j}).success(function(a){var b=a.State.Code,c=a.State.Message;return 0===b?(f.autoclose("线上民主协商完成!"),void d.fetchData()):void f.autoclose(c)}).error(function(a){f.autoclose(h.errorResult(a))})};a.seeItem=function(b){var c=a.seeFieldsList;h.bindFormData(b,c),d.openConfirm({template:"seeOne",controller:["$scope",function(a){a.fieldsList=c,a.closeDialog=function(){d.closeAll()}}],className:"ngdialog-theme-default",closeByDocument:!1})},a.AuditStates=[{Id:0,Name:"未审核"},{Id:1,Name:"审核通过"},{Id:2,Name:"审核驳回"}],a.ExtraResourceTypes=[{Checked:!1,Id:1,Name:"无"},{Checked:!1,Id:2,Name:"表单填写"},{Checked:!1,Id:4,Name:"线上民主协商"},{Checked:!1,Id:8,Name:"线下民主协商"},{Checked:!1,Id:16,Name:"线上临时协商"},{Checked:!1,Id:32,Name:"线下临时协商"},{Checked:!1,Id:64,Name:"核实"},{Checked:!1,Id:128,Name:"入库"}],a.NodeWorkerTypes=[{Id:1,Name:"审核"},{Id:2,Name:"普通"}],a.NodeWorkerType=1;var l=function(a,b,d){a.ngDialogPromise=c({method:"get",url:g.transacationList+"?length=9999&currentPage=1"}).success(function(c){var e=c.State.Code;c.State.Message;0===e&&(a.DemocraticProjects=c.Content.pagelist,b.forEach(function(b,c){"dpid"===b.name&&(b.opts=a.DemocraticProjects,b.originValue=a.DemocraticProjects[0]?a.DemocraticProjects[0].Id:"")}),d.resolve("success"))}).error(function(a){f.autoclose(h.errorResult(a))})},m=function(d,e){a.listBusyPromise=c({headers:b.pHeader,method:"get",url:g.finisherStorage+"?erid="+d+"&formid="+e}).success(function(a){var b=a.State.Code,c=a.State.Message;0===b?f.autoclose("表单填写事项处理完成！"):f.autoclose(c)}).error(function(a){f.autoclose(h.errorResult(a))})},n=function(d,e){a.listBusyPromise=c({headers:b.pHeader,method:"get",url:g.finishersFillform+"?erid="+d+"&formid="+e}).success(function(a){var b=a.State.Code,c=a.State.Message;0===b?f.autoclose("表单填写事项处理完成！"):f.autoclose(c)}).error(function(a){f.autoclose(h.errorResult(a))})},o=function(a,b,d,e,i){a.listBusyPromise=c({method:"get",url:g.erResourcebyworkerid+"?workerid="+b}).success(function(a){var b=a.State.Code,c=a.State.Message;if(0===b){var g=a.Content;switch(d){case 2:var h=g.FormId;if(0===h)return void f.autoclose("暂时无法完成该项操作！");n(e,h);break;case 4:break;case 8:break;case 16:break;case 32:break;case 64:break;case 128:var i=g.FormId;if(0===i)return void f.autoclose("暂时无法完成该项操作！");m(e,h)}}else f.autoclose(c)}).error(function(a){f.autoclose(h.errorResult(a))})},p=function(e){var j=i.defer(),k=j.promise,m=[{name:"dpid",nameDisplay:"协商项目",editor:"select",required:!0,value:"",originValue:"",opts:a.DemocraticProjects,column:1}];0===a.DemocraticProjects.length?l(a,m,j):j.resolve(),k.then(function(a){d.openConfirm({template:"createOne",controller:["$scope",function(a){h.initFormList(m),a.fieldsList=m,a.TitleText="事项处理",a.preTItie="线上民主协商",a.formSubmit=function(){var d=h.getFormData(a.fieldsList).dpid;a.DemocraticProjects.forEach(function(a,b){a.Id===d&&(DPName=a.Name)});var i={DPName:DPName,DPId:d};i=$.extend(!0,e,i),a.ngDialogPromise=c({headers:b.pHeader,method:"put",url:g.erDemoprojectonline,data:i}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose("更新操作成功！"),a.closeThisDialog()):f.autoclose(d)}).error(function(a){f.autoclose(errorResult(a))})}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},function(a){},function(a){})},q=function(a,b,d,e,i,k,q){a.listBusyPromise=c({method:"get",url:g.erByworkerid+"?workerid="+b}).success(function(c){var g=c.State.Code,h=c.State.Message;if(0===g){var r=c.Content,s=r.State,t=r.Id;if(q&&(q.resId=t),0===s)switch(d){case 2:o(a,b,d,t,e);break;case 4:l(a,k[1],e);break;case 8:o(a,b,d,t,e);break;case 16:o(a,b,d,t,e);break;case 32:o(a,b,d,t,e);break;case 64:o(a,b,d,t,e);break;case 128:o(a,b,d,t,e)}else if(1===s)switch(d){case 2:var u=r.FormId;if(0===u)return void f.autoclose("暂时无法完成该项操作！");n(t,u);break;case 4:k=k[0],p(r,k);break;case 8:break;case 16:break;case 32:break;case 64:break;case 128:var v=r.FormId;if(0===v)return void f.autoclose("暂时无法完成该项操作！");m(t,v)}else 2===s?(4===d&&(k=k[1]),j(a,i,k)):e.resolve("success")}else f.autoclose(h)}).error(function(a){f.autoclose(h.errorResult(a))})},r=function(a,b){var c={};e.regListSpecifyPage(a,{apiUrl:g.photoAlbum,params:c,success:function(c){a.Photoes=c,b&&b.resolve("success")},error:function(a){f.autoclose(errorResult(a))}})},s=function(a,d,e){e?url=g.photoItem:url=g.dophotoalbum,a.ngDialogPromise=c({headers:b.pHeader,method:"delete",url:url+"?id="+d.Id}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose("删除操作成功！"),a.getPhotoes(a)):f.autoclose(d)}).error(function(a){f.autoclose(errorResult(a))})},t=function(a,b){var c={albumid:b.Id};e.regListSpecifyPage(a,{apiUrl:g.photoitemList,params:c,success:function(b){a.Photoes=b},error:function(a){f.autoclose(errorResult(a))}})},u=function(a,b,c,d){var e=h.getFormData(c);e.AlbumId=d.Id},v=function(a,d,e,i,j){var k,l,m=h.getFormData(i);switch(e){case!0:k="post",l="新增";break;case!1:k="put",l="修改",j&&(m.Id=j.Id)}d.ngDialogPromise=c({headers:b.pHeader,method:k,url:g.dophotoalbum,data:m}).success(function(b){var c=b.State.Code,e=b.State.Message;0===c?(f.autoclose(l+"操作成功！"),a&&a.getPhotoes(a),setTimeout(function(){d.closeThisDialog()},1600)):f.autoclose(e)}).error(function(a){f.autoclose(errorResult(a))})},w=function(a,b,c,e,f,i,k){d.openConfirm({template:"createOne",controller:["$scope",function(d){d.fieldsList=[{name:"WorkExtraResource",nameDisplay:"外部资源类型",editor:"select",required:!0,opts:b,value:b[0].Id,column:1}],d.TitleText="选择",d.preTItie="操作",d.formSubmit=function(){var b=h.getFormData(d.fieldsList);switch(c.WorkExtraResource=b.WorkExtraResource,d.closeThisDialog(),c.WorkExtraResource){case 1:url=g.workerBlank+"?nextNoderId=",preTItie="普通（无）",f=i[1][0],k="createOne",j(d,a.NoderId,f,e);break;case 16:url=g.erResourcebyworkerid+"?workerid="+a.Id,preTItie="线上临时民主协商",f=i[1][4],newCreateOnline(f);break;case 32:url=g.erResourcebyworkerid+"?workerid="+a.Id,preTItie="线下临时民主协商无",f=i[1][5],newCreateOutline(f)}}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})};a.editItem=function(c){var e,f,l,m=i.defer(),n=m.promise,o=600,p=null,x=!0,y="",z=a.fetchData;switch(c.WorkNodeWorkerType){case 1:switch(f="审核",x=!1,l=g.workerAudit+"?nextNoderId=",c.AuditState){case 0:e=a.fieldsList[0][0],y="_createOne";break;case 1:e=a.fieldsList[0][1],y="createOne";break;case 2:}j(a,c.NoderId,e,m);break;case 2:x=!1,e=a.fieldsList[1][0];var A=c.WorkExtraResource,B=[];if(a.ExtraResourceTypes.forEach(function(a,b){(a.Id&A)===a.Id&&B.push(a)}),1!==B.length)w(c,B,a,m,e,a.fieldsList,y);else switch(A){case 1:l=g.workerBlank+"?nextNoderId=",f="普通（无）",e=a.fieldsList[1][0],y="createOne",j(a,c.NoderId,e,m);break;case 2:l=g.workerBlank+"?nextNoderId=",f="表单填写",e=a.fieldsList[1][0],y="_createOne",q(a,c.Id,c.ResourceType,m,c.NoderId,e);break;case 4:l=g.finisherDponline,f="线上民主协商",e=a.fieldsList[1],y="createOne",q(a,c.Id,c.ResourceType,m,c.NoderId,e,c);break;case 8:l=g.erResourcebyworkerid+"?workerid="+c.Id,f="线下民主协商",e=a.fieldsList[1][3],y="listOne",o=850,m.resolve("success");break;case 16:l=g.erResourcebyworkerid+"?workerid="+c.Id,f="线上临时民主协商",e=a.fieldsList[1][4],y="createOne",q(a,c.Id,c.ResourceType,m);break;case 32:l=g.erResourcebyworkerid+"?workerid="+c.Id,f="线下临时民主协商无",e=a.fieldsList[1][5],y="createOne",q(a,c.Id,c.ResourceType,m);break;case 64:l=g.erResourcebyworkerid+"?workerid="+c.Id,f="核实",e=a.fieldsList[1][6],y="createOne",q(a,c.Id,c.ResourceType,m);break;case 128:l=g.erResourcebyworkerid+"?workerid="+c.Id,f="入库",e=a.fieldsList[1][7],y="createOne",q(a,c.Id,c.ResourceType,m)}}n.then(function(g){h.initFormList(e);var i=a.DemocraticProjects;d.openConfirm({template:y,controller:["$scope",function(a){a.fetchData=z,a.preTItie=f,a.TitleText="事项处理",a.fieldsList=e,a.Photoes=[],2===c.WorkNodeWorkerType&&4===c.ResourceType&&(a.DemocraticProjects=i),2===c.WorkNodeWorkerType&&8===c.ResourceType&&(a.TitleName="相册",a.getPhotoes=function(a,b){r(a,b)},a.AlbumManage=function(a){d.openConfirm({template:"listOne",controller:["$scope",function(b){b.TitleText="照片",b.preTItie="管理",b.TitleName="照片",t(b,a),b.createAlbum=function(){var c=b;d.openConfirm({template:"createOne",controller:["$scope",function(b){b.fieldsList=[{name:"PhotoUrl",nameDisplay:"选择照片",editor:"file-upload",required:!0,value:""},{name:"Name",nameDisplay:"名称",editor:"normal",required:!1,value:""},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:""},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:""}],b.TitleText="新增",b.preTItie="照片",b.formSubmit=function(){u(c,b,b.fieldsList,a)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},b.deleteAlbum=function(a){s(b,a,!0)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},a.deleteAlbum=function(b){s(a,b)},a.getPhotoes(a,m),a.editAlbum=function(b){var c=a;d.openConfirm({template:"createOne",controller:["$scope",function(a){a.fieldsList=[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:"",column:1},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:"",column:1},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:"",column:1}],h.bindFormData(b,a.fieldsList),a.TitleText="修改",a.preTItie="相册",a.formSubmit=function(){v(c,a,!1,a.fieldsList,b)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},a.createAlbum=function(){var b=a;d.openConfirm({template:"createOne",controller:["$scope",function(a){a.fieldsList=[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:"",column:1},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:"",column:1},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:"",column:1}],a.TitleText="新增",a.preTItie="相册",a.formSubmit=function(){v(b,a,!0,a.fieldsList)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})}),a.closeDialog=function(){d.closeAll()},a.formSubmit=function(){var d;switch(c.WorkNodeWorkerType){case 1:switch(p={Id:c.Id},h.getFormData(a.fieldsList).nextNoderId?d=h.getFormData(a.fieldsList).nextNoderId:p.nextNoderId=0,l+=d,c.AuditState){case 0:break;case 1:p.AuditState=c.AuditState;break;case 2:}break;case 2:switch(p={Id:c.Id},c.ResourceType){case 1:d=h.getFormData(a.fieldsList).nextNoderId,d||(d=0),l+=d;break;case 2:d=h.getFormData(a.fieldsList).nextNoderId,d||(d=0),l+=d;break;case 4:var e=h.getFormData(a.fieldsList).dpid,f="";a.DemocraticProjects.length>0&&a.DemocraticProjects.forEach(function(a,b){a.Id===e&&(f=a.Name)});var g=c.resId?c.resId:0;k(a,g,e,f);break;case 8:break;case 16:break;case 32:break;case 64:break;case 128:}}h.formSubmit(a,x,a.fieldsList,l,null,p,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:o})},function(a){},function(a){})}}]);