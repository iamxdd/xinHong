/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("shixiangmubanCtrl",["$scope","$rootScope","ngDialog","layerAlert","$http","serverUrls","PcService","$q",function(a,b,c,d,e,f,g,h){a.list=[],a.TitleText="新增",a.searchOption={usageLv:-1},a.PcService=g,a.EventCategory=[],a.workFlows=[],a.Owners=[],a.autoProcess=[{Id:!0,Name:"是"},{Id:!0,Name:"是"}];var i=function(a,b){a.listBusyPromise=e({method:"get",url:f.eventownerList+"?length=9999&currentPage=1"}).success(function(c){var d=c.State.Code;c.State.Message;0===d&&(a.Owners=c.Content.pagelist,a.fieldsList.forEach(function(b,c){return"OwnerId"===b.name?(b.opts=a.Owners,void(b.originValue=a.Owners[0].Id)):void 0}),b&&b.resolve())}).error(function(a){d.autoclose(g.errorResult(a))})},j=function(){e({method:"get",url:f.workflowList+"?length=9999&currentPage=1"}).success(function(b){var c=b.State.Code;b.State.Message;0===c&&(a.workFlows=b.Content.pagelist,a.fieldsList.forEach(function(b,c){return"WorkflowInspectorId"===b.name?(b.opts=a.workFlows,void(b.originValue=a.workFlows[0].Id)):void 0}))}).error(function(a){d.autoclose(g.errorResult(a))})},k=function(b){e({method:"get",url:f.eventCategorylist+"?length=9999&currentPage=1"}).success(function(c){var d=c.State.Code;c.State.Message;0===d&&(b&&(b.eventTypes=c.Content.pagelist),a.EventCategory=c.Content.pagelist,a.fieldsList.forEach(function(b,c){return"CategoryId"===b.name?(b.opts=a.EventCategory,void(b.originValue=a.EventCategory[0].Id)):void 0}),0===a.workFlows.length?j():g.fetchData(a,f.eventInspectorlist,a.searchOption))}).error(function(a){d.autoclose(g.errorResult(a))})},l=function(a,b,c,f,h){var i=g.getFormData(f);b.ngDialogPromise=e({headers:h,method:"post",url:c,data:i}).success(function(c){var e=c.State.Code;c.State.Message;0===e&&(d.autoclose("新增成功！"),k(a),b.closeThisDialog())}).error(function(a){d.autoclose(g.errorResult(a))})},m=function(a){var d=a;c.openConfirm({template:"createOne",controller:["$scope",function(a){a.TitleText="新增事项类型",a.fieldsList=[{name:"Name",nameDisplay:"事项名称",editor:"normal",required:!0,value:"",originValue:"",column:1}],a.formSubmit=function(){l(d,a,f.eventCategory,a.fieldsList,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},n=function(a,b,c,f){a.ngDialogPromise=e({headers:f,method:"delete",url:b+"?id="+c.Id}).success(function(b){var c=b.State.Code,e=b.State.Message;0===c?(d.autoclose("删除成功!"),k(a)):d.autoclose(e)}).error(function(a){d.autoclose(g.errorResult(a))})};a.eventTypeManage=function(){var d=a;a.showAutoNode=!1,c.openConfirm({template:"eventTypeManage",controller:["$scope",function(a){a.TitleText="事项类型管理",a.eventTypes=d.EventCategory,a.createEventType=function(){m(a)},a.deleteMember=function(c){n(a,f.eventCategory,c,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},a.usageLvs=[{Id:0,Name:"居民"},{Id:1,Name:"区域管理员"}],a.HandleLevels=[{Id:0,Name:"院落"},{Id:1,Name:"楼栋"},{Id:2,Name:"单元"},{Id:3,Name:"户"}];var o=function(a,b,c){var d={};return a.forEach(function(a,e){return a.name===b?void a.opts.forEach(function(b,e){b.Id===a.value&&(d[c]=b.Name)}):void 0}),d};a.creatOne=function(){a.showAutoNode=!0;var d=h.defer(),e=d.promise;i(a,d),e.then(function(){var d=a.fetchData,e=a.fieldsList;g.initFormList(e),e.forEach(function(a,b){a.editable=!1,a.isHide&&(a.isHide=!0)}),c.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.fieldsList=e,a.TitleText="新增",a.fetchData=d,a.autoProcess=[{Id:!0,Name:"是"},{Id:!1,Name:"否"}],a.AutoProcessWorkflows=[],a._param={AutoProcess:!1,AutoProcessWorkflowId:0,AutoProcessWorkflowName:""},a.isAutoProcess=function(b){b&&(a.AutoProcessWorkflows=a.$parent.$parent.workFlows,a._param.AutoProcessWorkflowId=a.AutoProcessWorkflows[0].Id)},a.formSubmit=function(){a._param.AutoProcess&&a.AutoProcessWorkflows.forEach(function(b,c){return b.Id===a._param.AutoProcessWorkflowId?void(a._param.AutoProcessWorkflowName=b.Name):void 0});var c=o(a.fieldsList,"WorkflowInspectorId","WorkflowInspectorName");c=$.extend(!0,c,a._param),c.UsageLevel=0,g.formSubmit(a,!0,a.fieldsList,f.inEventinspector,null,c,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})})};var p=function(a,b,c){b._param.AutoProcess=a.AutoProcess,a.AutoProcess&&(b._param.AutoProcessWorkflowId=a.AutoProcessWorkflowId)};a.editItem=function(d){var e=h.defer(),j=e.promise;i(a,e),j.then(function(){var e=a.fetchData,h=a.fieldsList;g.bindFormData(d,h),p(d,h),h.forEach(function(a,b){a.editable=!1,a.isHide&&(a.isHide=!0)}),c.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.fieldsList=h,a.TitleText="修改",a.fetchData=e,a.autoProcess=[{Id:!0,Name:"是"},{Id:!1,Name:"否"}],a.AutoProcessWorkflows=a.$parent.$parent.workFlows,a._param={AutoProcess:!1,AutoProcessWorkflowId:0,AutoProcessWorkflowName:""},a.formSubmit=function(){var c=o(a.fieldsList,"WorkflowInspectorId","WorkflowInspectorName");g.formSubmit(a,!1,a.fieldsList,f.upEventinspector,d,c,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})})},a.seeItem=function(b){var d=h.defer(),e=d.promise;i(a,d),e.then(function(){var d=a.fieldsList;g.bindFormData(b,d),d.forEach(function(a,b){a.editable=!0,a.isHide&&(a.isHide=!1)}),c.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.fieldsList=d,a.TitleText="查看",a.seeing=!0,a.autoProcess=[{Id:!0,Name:"是"},{Id:!1,Name:"否"}],a.AutoProcessWorkflows=a.$parent.$parent.workFlows,a._param={AutoProcess:!1,AutoProcessWorkflowId:0,AutoProcessWorkflowName:""},p(b,a,d),a.formSubmit=function(){a.closeThisDialog()}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})})},a.fetchData=function(){g.fetchData(a,f.eventInspectorlist,a.searchOption),0===a.EventCategory.length?k():0===a.workFlows.length&&j()},a.fetchData(),a.toggleItem=function(b){g.toggleStatus(a,b,f.eventInspector)},a.ScopeList=[{Id:0,Name:"信息上报"}],a.OpenStates=[{Id:1,Name:"启用"},{Id:2,Name:"停用"}],a.fieldsList=[{name:"Name",nameDisplay:"事项名称",editor:"normal",required:!0,value:"",originValue:""},{name:"Scope",nameDisplay:"范围",editor:"select",required:!0,opts:a.ScopeList,value:"",originValue:a.ScopeList[0].Id},{name:"CategoryId",nameDisplay:"事项类型",editor:"select",required:!0,opts:a.EventCategory,value:""},{name:"HandleLevel",nameDisplay:"事项处理级别",editor:"select",required:!0,value:"",opts:a.HandleLevels,originValue:a.HandleLevels[0].Id},{name:"OpenState",nameDisplay:"启用状态",editor:"select",required:!0,value:"",opts:a.OpenStates,originValue:a.OpenStates[0].Id},{name:"WorkflowInspectorId",nameDisplay:"工作流模板",editor:"select",required:!0,value:"",opts:a.workFlows},{name:"OwnerId",nameDisplay:"拥有者",editor:"select",required:!1,value:"",opts:a.Owners},{name:"CreatorNickName",nameDisplay:"创建者",editor:"normal",required:!1,value:"",originValue:"",isHide:!0},{name:"LastEditorNickName",nameDisplay:"最后修改者",editor:"normal",required:!1,value:"",originValue:"",isHide:!0},{name:"CreatedAt",nameDisplay:"创建时间",editor:"normal",required:!1,value:"",originValue:"",isHide:!0},{name:"UpdatedAt",nameDisplay:"更新时间",editor:"normal",required:!1,value:"",originValue:"",isHide:!0}]}]);