/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("todoListCtrl",["$scope","$rootScope","$http","ngDialog","PagerExtends","layerAlert","serverUrls","PcService","$q",function(a,b,c,d,e,f,g,h,i){a.themeList=[],a.photoAlbumList=[];var j=function(a){var b=Function;return new b("return "+a)()},k=j("("+localStorage.getItem("myCountInfo")+")"),l=k.memberid;a.PcService=h,a.navTabList=[{Id:1,Name:"信息核实",Active:!0},{Id:2,Name:"事项处理",Active:!1}],a.selectTab=a.navTabList[0],a.ExtraResourceTypes=[{Checked:!1,Id:1,Name:"无"},{Checked:!1,Id:2,Name:"表单填写"},{Checked:!1,Id:4,Name:"线上民主协商"},{Checked:!1,Id:8,Name:"线下民主协商"},{Checked:!1,Id:16,Name:"线上临时协商"},{Checked:!1,Id:32,Name:"线下临时协商"},{Checked:!1,Id:64,Name:"核实"},{Checked:!1,Id:128,Name:"入库"}],a.fieldsList=[[{name:"verifyState",nameDisplay:"核实操作",editor:"select",required:!0,value:"",originValue:1,opts:[{Id:1,Name:"核实有效"},{Id:2,Name:"核实无效"}]},{name:"nextNoderId",nameDisplay:"下一节点",editor:"select",required:!1,value:"",originValue:"",opts:[]},{name:"note",nameDisplay:"备注",editor:"textarea",required:!1,value:"",originValue:""}],[{name:"AuditState",nameDisplay:"审核操作",editor:"select",required:!0,value:"",originValue:1,opts:[{Id:1,Name:"审核通过"},{Id:2,Name:"审核驳回"}]},{name:"nextNoderId",nameDisplay:"下一节点",editor:"select",required:!1,value:"",originValue:""}],[{name:"nextNoderId",nameDisplay:"下一节点",editor:"select",required:!1,value:"",originValue:""}],[{name:"nextNoderId",nameDisplay:"协商议题",editor:"select",required:!1,value:"",originValue:""}],[{name:"nextNoderId",nameDisplay:"选择相册",editor:"select",required:!1,value:"",originValue:""}],[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:"",originValue:""},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:"",originValue:""},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:"",originValue:""}],[{name:"DPId",nameDisplay:"选择协商议题",editor:"select",required:!0,value:"",originValue:""},{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:"",originValue:""},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:"",originValue:""},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:"",originValue:""}],[{name:"photoAlbumId",nameDisplay:"选择相册",editor:"select",required:!0,value:"",originValue:""},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:"",originValue:""},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:"",originValue:""}]],a.checked=function(b){a.navTabList.forEach(function(a,c){a.Name===b.Name?a.Active=!0:a.Active=!1}),a.selectTab!==b&&(a.selectTab=b,a.fetchData())},a.fetchData=function(){var c={},d="";switch(a.selectTab.Id){case 1:c.history=!1,c.verify=!0,d=g.allWorkers,h.fetchData(a,d,c,b.gHeader);break;case 2:c.history=!1,c.verify=!1,d=g.allWorkers,h.fetchData(a,d,c,b.gHeader);break;case 3:c.mid=l,d=g.demoCratictransactionbymid,h.fetchList(a,d,c,b.gHeader)}},a.fetchData(),a.todoText=function(a){var b;switch(a.Id){case 1:b="立即核实";break;case 2:b="立即处理"}return b};var m=function(a,d){var e=g.finisherVerification,i=h.getFormData(a.fieldsList);0===i.nextNoderId&&delete i.nextNoderId,i.workerid=d;var j="?";if(i){for(var k in i)j+=k+"="+i[k]+"&";e+=j.substring(0,j.length-1)}a.ngDialogPromise=c({headers:b.pHeader,method:"get",url:e}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose("核实操作成功！"),a.$parent.$parent.fetchData(),setTimeout(function(){a.closeThisDialog()},1600)):f.autoclose(d)}).error(function(a){f.autoclose(h.errorResult(a))})},n=function(a,b){a.listBusyPromise=c({method:"get",url:g.photoAlbum+"?length=999&currentPage=1"}).success(function(c){var d=c.State.Code,e=c.State.Message;if(0===d){var g=c.Content.pagelist;a.photoAlbumList=c.Content.pagelist,0===g.length&&(g=[{Id:0,Name:"无"}]),a.fieldsList[4][0].opts=g,a.fieldsList[4][0].value=g[0].Id,a.fieldsList[7].forEach(function(b,c){"photoAlbumId"===b.name&&(b.opts=a.photoAlbumList,b.originValue=a.photoAlbumList[0]?a.photoAlbumList[0].Id:"")}),b.resolve("success")}else f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})},o=function(a,b){a.listBusyPromise=c({method:"get",url:g.transacationList+"?length=999&currentPage=1"}).success(function(c){var d=c.State.Code,e=c.State.Message;if(0===d){var g=c.Content.pagelist;a.themeList=c.Content.pagelist,0===g.length&&(g=[{Id:0,Name:"无"}]),a.fieldsList[3][0].opts=g,a.fieldsList[3][0].value=g[0].Id,a.fieldsList[6].forEach(function(b,c){"DPId"===b.name&&(b.opts=a.themeList,b.originValue=a.themeList[0]?a.themeList[0].Id:"")}),b.resolve("success")}else f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})},p=function(a,b,d,e){a.listBusyPromise=c({method:"get",url:g.nextNoders+"?noderid="+b.Id}).success(function(b){var c=b.State.Code,g=b.State.Message;if(0===c){var h=b.Content;0===h.length&&(h=[{Id:0,Name:"无"}]),(e||0===e)&&a.fieldsList[e].forEach(function(a,b){"nextNoderId"===a.name&&(a.opts=h,a.value=a.originValue=h[0].Id)}),d&&d.resolve()}else f.autoclose(g)}).error(function(a){f.autoclose(h.errorResult(a))})},q=function(a,b){var c=i.defer();p(a,b,c,0);var e=c.promise;e.then(function(){d.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.TitleText="信息核实操作",a.fieldsList=a.$parent.$parent.fieldsList[0],h.initFormList(a.fieldsList),a.formSubmit=function(){m(a,b.Id)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},function(a){console.log(a)},function(){console.log(value)})},r=function(a,d){var e=g.workerAudit,i=h.getFormData(a.fieldsList);2===i.AuditState&&(i.nextNoderId=0),i.Id=d,a.ngDialogPromise=c({headers:b.pHeader,method:"put",url:e+"?nextNoderId="+i.nextNoderId,data:i}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose("审核操作成功！"),a.$parent.$parent.fetchData(),setTimeout(function(){a.closeThisDialog()},1600)):f.autoclose(d)}).error(function(a){f.autoclose(h.errorResult(a))})},s=function(a,b){var c=i.defer();p(a,b,c,1);var e=c.promise;e.then(function(){d.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.TitleText="处理事项前请先审核",a.fieldsList=a.$parent.$parent.fieldsList[1],h.initFormList(a.fieldsList),a.formSubmit=function(){r(a,b.Id)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},function(a){console.log(a)},function(){console.log(value)})},t=function(a,c){var d=a.fieldsList[2],e=h.getFormData(d).nextNoderId,f=g.workerBlank+"?nextNoderId="+e,i={Id:c.Id};h.formSubmit(a,!1,[],f,c,i,b.pHeader)},u=function(a,c){var e=i.defer();p(a,c,e,2);var f=e.promise;f.then(function(){d.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.TitleText="普通事项处理",a.fieldsList=a.$parent.$parent.fieldsList[2],a.formSubmit=function(){var d=h.getFormData(a.fieldsList).nextNoderId,e=g.workerBlank+"?nextNoderId="+d,f={Id:c.Id};h.formSubmit(a,!1,[],e,{},f,b.pHeader,"普通工作")}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})})},v=function(d,e){a.listBusyPromise=c({method:"get",headers:b.pHeader,url:g.finisherDpoffline+"?erid="+d+"&albumid="+e}).success(function(b){var c=b.State.Code;b.State.Message;0===c?(f.autoclose("线下民主协商事项处理完成！"),setTimeout(function(){a.fetchData()},1600)):f.autoclose(Mesage)}).error(function(a){f.autoclose(h.errorResult(a))})},w=function(a,d,e,h){a.listBusyPromise=c({method:"get",headers:b.pHeader,url:g.finisherDponline+"?erid="+d+"&dpid="+e+"&dpname="+h}).success(function(b){var c=b.State.Code;b.State.Message;0===c?(f.autoclose("线上民主协商事项处理完成！"),setTimeout(function(){a.fetchData()},1600)):f.autoclose("暂时无法完成该项操作")}).error(function(a){f.autoclose(pcservice.errorResult(a))})},x=function(a,d,e){$listBusyPromise=c({headers:b.pHeader,method:"get",url:g.finisherStorage+"?erid="+d+"&formid="+e}).success(function(b){var c=b.State.Code;b.State.Message;0===c?(f.autoclose("入库事项处理完成！"),setTimeout(function(){a.fetchData()},1600)):f.autoclose("入库失败")}).error(function(a){f.autoclose(h.errorResult(a))})},y=function(a,d,e,i){switch(d.ResourceType){case 2:a.listBusyPromise=c({headers:b.pHeader,method:"get",url:g.finishersFillform+"?erid="+e+"&formid="+i.FormId}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose("表单填写事项处理完成！"),setTimeout(function(){a.fetchData()},1600)):f.autoclose(d)}).error(function(a){f.autoclose(h.errorResult(a))});break;case 4:var j=i.DPId,k=i.DPName;w(a,e,j,k);break;case 8:var l=i.PhotoAlbumId;v(e,l);break;case 128:var m=i.FormId;if(0===m)return void f.autoclose("暂时无法完成该项操作！");x(a,e,m)}},z=function(a,c){var e=i.defer(),f=e.promise;0===a.themeList.length?o(a,e):e.resolve(),f.then(function(e){d.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.TitleText="事项处理-线上民主协商",a.fieldsList=a.$parent.$parent.fieldsList[6],h.bindFormData(a.themeList,a.fieldsList),a.formSubmit=function(){var d,e=h.getFormData(a.fieldsList).DPId;a.themeList.forEach(function(a,b){a.Id===e&&(d=a.Name)});var f=h.getFormData(a.fieldsList);f.DPName=d,f.Id=c,h.formSubmit(a,!1,[],g.erDemoprojectonline,a.themeList,f,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},function(a){},function(a){})},A=function(a,c){var e=i.defer(),f=e.promise;0===a.photoAlbumList.length?n(a,e):e.resolve(),f.then(function(e){d.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.TitleText="事项处理-线下民主协商",a.fieldsList=a.$parent.$parent.fieldsList[7],h.bindFormData(a.photoAlbumList,a.fieldsList),a.formSubmit=function(){var d=h.getFormData(a.fieldsList);d.Id=c,h.formSubmit(a,!1,[],g.erDemoprojectoffline,a.photoAlbumList,d,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})})},B=function(a,c,e){e.FormType;d.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.TitleText="更新表单",a.fieldsList=a.$parent.$parent.fieldsList[5],h.bindFormData(e,a.fieldsList);var d=h.getFormData(a.fieldsList);d.FormType=e.FormType,d.FormId=e.FormId,d.Id=c,a.formSubmit=function(){h.formSubmit(a,!1,[],g.erFillform,e,d,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},C=function(a,c,e){e.FormType;d.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.TitleText="更新入库",a.fieldsList=a.$parent.$parent.fieldsList[5],h.bindFormData(e,a.fieldsList);var d=h.getFormData(a.fieldsList);d.FormType=e.FormType,d.FormId=e.FormId,d.Id=c,a.formSubmit=function(){h.formSubmit(a,!1,[],g.erstorage,e,d,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},D=function(a,b,d){a.listBusyPromise=c({method:"get",url:g.erResourcebyworkerid+"?workerid="+b.Id}).success(function(c){var e=c.State.Code;c.State.Message;if(0===e){var g=c.Content;switch(b.ResourceType){case 2:var h=g.FormId;if(0===h)return void f.autoclose("暂时无法完成该项操作！");b.Id;B(a,d,g);break;case 4:z(a,d);break;case 8:A(a,d);break;case 128:C(a,d,g)}}}).error(function(a){f.autoclose(h.errorResult(a))})},E=function(a,b){a.listBusyPromise=c({method:"get",url:g.erByworkerid+"?workerid="+b.Id}).success(function(c){var d=c.State.Code,e=c.State.Message;if(0===d){var g=c.Content,h=g.State,i=g.Id;switch(h){case 0:D(a,b,i);break;case 1:g.FormId;y(a,b,i,g);break;case 2:u(a,b)}}else f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})},F=function(a,b){var c=[];if(a.ExtraResourceTypes.forEach(function(a,d){(a.Id&b.WorkExtraResource)===a.Id&&c.push(a)}),1===c.length)switch(b.ResourceType){case 1:u(a,b);break;case 2:E(a,b);break;case 4:E(a,b);break;case 8:E(a,b);break;case 16:E(a,b);break;case 32:E(a,b);break;case 64:E(a,b);break;case 128:E(a,b)}else d.openConfirm({template:"createOne_multi",scope:a,controller:["$scope",function(a){a.TitleText="请选择下一步操作",a.baseInfos=b,a._fieldsList=[{name:"verifyState",nameDisplay:"请选择操作",editor:"select",required:!0,value:c[0].Id,originValue:c[0].Id,opts:c}],a.NextNodes=[{Id:0,Name:"无"}],a.choseNextNode=function(c){switch(c){case 1:p(a,b,null,2);break;case 16:o(a);break;case 32:n(a,deffered)}},a.choseNextNode(c[0].Id),a.formSubmit=function(){var c=a._fieldsList[0].value;switch(c){case 1:t(a,b);break;case 16:a.closeThisDialog(0),E(a,b);break;case 32:a.closeThisDialog(0),E(a,b)}}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},G=function(a,b){switch(b.WorkNodeWorkerType){case 1:s(a,b);break;case 2:F(a,b)}};a.editItem=function(b){switch(a.selectTab.Id){case 1:q(a,b);break;case 2:G(a,b);break;case 3:q(a,b)}}}]);