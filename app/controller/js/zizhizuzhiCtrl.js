/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("zizhizuzhiCtrl",["$scope","$http","ngDialog","PagerExtends","layerAlert","serverUrls","PcService","$q",function(a,b,c,d,e,f,g,h){a.list=[],a.searchOption={name:""},a.PcService=g,a.serverUrls=f,a.TitleText="",a.courtyardAll=[],a.Grids=[{Id:0,Name:"请选择"}],a.Roles=[{Id:0,Name:"请选择"}],a.PreOrganization=[{Id:0,Name:"无"}];var i=function(a,b,c){c.forEach(function(c,d){c.name===a&&(c.opts=b,c.originValue=b[0]?b[0].Id:"")})},j=function(a,c){a.listBusyPromise=b({method:"get",url:f.gridList+"?length=9999&currentPage=1"}).success(function(b){var d=b.State.Code,f=b.State.Message;0===d?(a.Grids=b.Content.pagelist,i("GridId",a.Grids,a.fieldsList),c.resolve("success")):e.autoclose(f)}).error(function(a){e.autoclose(g.errorResult(a))})},k=function(a,c){a.listBusyPromise=b({method:"get",url:f.Associationall+"?state=0"}).success(function(b){var d=b.State.Code,f=b.State.Message;if(0===d){var g=[{Id:0,Name:"无"}];a.PreOrganization=g.concat(b.Content),i("ParentId",a.PreOrganization,a.fieldsList),c&&j(a,c)}else e.autoclose(f)}).error(function(a){e.autoclose(g.errorResult(a))})},l=function(){a.listBusyPromise=b({method:"get",url:f.courtyardAll+"?openstate=1"}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(a.courtyardAll=b.Content,i("CourtyardId",a.courtyardAll,a.fieldsList)):e.autoclose(d)}).error(function(a){e.autoclose(g.errorResult(a))})};a.fetchData=function(){g.fetchData(a,f.associationList,a.searchOption),0===a.courtyardAll.length&&l()},a.fetchData(),a.creatOne=function(){var b=h.defer(),d=b.promise;k(a,b),d.then(function(){var b=a.fieldsList,d=a.fetchData;g.initFormList(b),c.openConfirm({template:"createOne",controller:["$scope",function(a){a.TitleText="新增",a.fieldsList=b,a.fetchData=d,a.formSubmit=function(){g.formSubmit(a,!0,a.fieldsList,f.inAssociation)}}],className:"ngdialog-theme-default",closeByDocument:!1})})},a.editItem=function(b){var d=h.defer(),e=d.promise;k(a,d),e.then(function(){var d=a.fieldsList,e=a.fetchData;g.bindFormData(b,d),c.openConfirm({template:"createOne",controller:["$scope",function(a){a.TitleText="编 辑",a.fieldsList=d,a.fetchData=e,a.formSubmit=function(){g.formSubmit(a,!1,a.fieldsList,f.upAssociation,b)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})})},a.formSubmit=function(){alert()},a.fieldsList=[{name:"CourtyardId",nameDisplay:"院落",editor:"select",required:!0,value:"",originValue:""},{name:"Name",nameDisplay:"组织名称",editor:"normal",required:!0,value:"",originValue:""},{name:"ParentId",nameDisplay:"上级组织",editor:"select",required:!0,value:"",opts:a.PreOrganization,originValue:a.PreOrganization[0].Id},{name:"GridId",nameDisplay:"自治单元",editor:"select",required:!0,value:"",opts:a.Grids,originValue:a.Grids[0].Id},{name:"Telephone",nameDisplay:"联系电话",editor:"normal",required:!0,value:"",originValue:""},{editor:"textarea",name:"Describe",nameDisplay:"描述",required:!1,value:"",originValue:""},{name:"Sort",nameDisplay:"排序号",editor:"normal",required:!1,value:"",originValue:""}];var m=function(a,b){var c={autonomyOrganizationsId:b.Id};d.regListSpecifyPage(a,{apiUrl:f.staffList,params:c,success:function(b){a.MemberList=b},error:function(a){e.autoclose(a)}})},n=function(a,c){c&&(a.getResidentPromise=b({method:"get",url:f.negotiationList+"?value="+c}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(a.ResidentStatus=b.Content,a.ResidentStatus&&a.ResidentStatus.length>0?(a.ResidentStatus.forEach(function(a,b){a.Id=a.ResidentStatus}),a.fieldsList[0].opts=a.ResidentStatus,a.fieldsList[0].value=a.ResidentStatus[0]?a.ResidentStatus[0].Id:""):e.autoclose("当前关键字没有相关居民，请重新搜索！")):e.autoclose(d)}).error(function(a){e.autoclose(g.errorResult(a))}))},o=function(a,c){a.getResidentPromise=b({method:"delete",url:f.deStaff+"?id="+c.Id}).success(function(b){var d=b.State.Code,f=b.State.Message;0===d?(e.autoclose("删除成功！"),a.MemberList.forEach(function(b,d){b.Id===c.Id&&a.MemberList.splice(d,1)}),a.fetchData()):e.autoclose(f)}).error(function(a){e.autoclose(g.errorResult(a))})},p=function(a,b){b.forEach(function(b,c){if("ResidentStatus"===b.name){var d=[{Id:a[b.name],Name:a.Name}],e=!1;b.opts.forEach(function(a,b){return a.Id===d[0].Id?void(e=!0):void 0}),e||(b.opts=b.opts.concat(d))}void 0!==a[b.name]&&(b.value=a[b.name])})},q=function(a,c,d,h){c.ngDialogPromise=c.listBusyPromise=b({method:"post",url:f.inStaff,data:d}).success(function(b){var d=b.State.Code,f=b.State.Message;0===d?(e.autoclose("新增成功!"),a&&a.getMemberList(a,h),setTimeout(function(){c.closeThisDialog()},1600)):e.autoclose(f)}).error(function(a){e.autoclose(g.errorResult(a))})};a.MembersManageItem=function(b){var d=h.defer(),g=(d.promise,a.Roles),i=a.Grids,j=a.fetchData,k=a.PcService;c.openConfirm({template:"MemberManage",controller:["$scope",function(a){a.TitleText="编 辑",a.Roles=g,a.Roles.forEach(function(a,b){a.Id=a.Code}),a.Grids=i,a.fetchData=j,a.PcService=k,m(a,b),a.getMemberList=m,a.staffStatus=[{Id:1,Name:"自治"},{Id:2,Name:"网格"}],a.fieldsList=[{editor:"select",name:"ResidentStatus",nameDisplay:"选择居民",required:!0,value:"",originValue:0,opts:[{Id:0,Name:"请选择"}]},{editor:"select",name:"Code",nameDisplay:"角色",required:!0,value:"",originValue:a.Roles[0].Id,opts:a.Roles},{editor:"select",name:"GridId",nameDisplay:"区域",required:!0,value:"",originValue:a.Grids[0].Id,opts:a.Grids}],a.addMember=function(){var d=a,f=a.fieldsList;k.initFormList(f);var g=a.fetchData;c.openConfirm({template:"createMember",controller:["$scope",function(a){a.TitleText="新增",a.fieldsList=f,a.fetchData=g,a.Resident={value:""},a.getResidentStatus=function(){n(a,a.Resident.value)},a.formSubmit=function(){var c={AutonomyOrganizationsId:b.Id};return 0===a.fieldsList[0].value?void e.autoclose("居民身份不能为空!"):(c=$.extend(!0,c,k.getFormData(a.fieldsList)),void q(d,a,c,b))}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},a.modifyMember=function(d){var g=a.fieldsList,h=a.fetchData;c.openConfirm({template:"createMember",controller:["$scope",function(a){a.TitleText="修改",a.fieldsList=g,p(d,a.fieldsList),a.fetchData=h,a.Resident={value:""},a.getResidentStatus=function(){n(a.Resident.value)},a.formSubmit=function(){var c={AutonomyOrganizationsId:b.Id};return 0===a.fieldsList[0].value?void e.autoclose("居民身份不能为空!"):void k.formSubmit(a,!1,a.fieldsList,f.upStaff,d,c)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},a.deleteMember=function(b){o(a,b)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},a.toggleItem=function(b){g.toggleItem(a,b,f.associationState)}}]);