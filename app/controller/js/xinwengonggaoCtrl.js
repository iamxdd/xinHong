/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("xinwengonggaoCtrl",["$scope","$rootScope","$http","ngDialog","PagerExtends","layerAlert","datepickerConfig","serverUrls","PcService","$filter","$q",function(a,b,c,d,e,f,g,h,i,j,k){a.list=[],a.PcService=i,a.TitleText="新增",a.publicationScope=[],a.newsTypes=[],a.searchOption={},a.categoryOption={value:""},a.channelOption={name:""},a.news={},a.navTabList=[{Id:1,Name:"新闻公告列表",Active:!0},{Id:2,Name:"新闻类型管理",Active:!1},{Id:3,Name:"发布范围管理",Active:!1}],a.selectItem=a.navTabList[0],a.checked=function(b){a.selectItem=b,a.navTabList.forEach(function(a,c){a.Id===b.Id?a.Active=!0:a.Active=!1}),a.fetchData()},a.toggleCategory=function(b){i.toggleItem(a,b,h.channelTypestate)},a.ChannelTypes=function(a){var b="";return a&&0!==a.length?(a.forEach(function(a,c){b+=a.ChannelTypeName+","}),b=b.substring(0,b.length-1)):b="无",b};var l=function(a,b){a.listBusyPromise=c({method:"get",url:h.informationTypeList}).success(function(c){var d=c.State.Code,e=c.State.Message;0===d?(a.newsTypes=c.Content,b.resolve()):f.autoclose(e)}).error(function(a){f.autoclose(i.errorResult(a))})},m=function(a,b){a.listBusyPromise=c({method:"get",url:h.channelTypelist+"?length=9999&currentPage=1&openstate=1"}).success(function(c){var d=c.State.Code,e=c.State.Message;0===d?(a.publicationScope=c.Content.pagelist,l(a,b)):f.autoclose(e)}).error(function(a){f.autoclose(i.errorResult(a))})};a.newsTypes=[{Id:0,Name:"请选择"}],a.disabledItem=function(a){var b=!0;return 2===a.State&&(b=!1),b},a.classItem=function(a){return{"btn-info":2===a.InformationState,"btn-default":2!==a.InformationState}};var n=function(a){var b={};return a.forEach(function(a,c){"double-datePick"===a.editor?(b[a.name1]=a.value1,b[a.name2]=a.value2):b[a.name]=a.value}),b},o=function(b){b.CategoryId=a.newsTypes[0].Id,b.Title="",b.Author="",b.Content="",b.Abstract="",b.ChannelType=a.publicationScope[0].Id},p=function(a,e,g,k,l,m){if(!g.ChannelType)return void f.autoclose("发布范围不能为空！");var n,o,p,q={Title:g.Title,CategoryId:g.CategoryId,Content:g.Content,Abstract:g.Abstract,Author:g.Author,ChannelType:g.ChannelType,Draft:e};switch(k){case!0:n=h.addInformation,o="post",p="新增";break;case!1:n=h.upInformation,o="put",p="修改",q.Id=l}var r="";switch(e){case!0:r="草稿";break;case!1:r="新闻"}a.ngDialogPromise=c({headers:b.pHeader,method:o,url:n,data:q}).success(function(b){var c=b.State.Code,e=b.State.Message;0===c?(f.autoclose(p+r+"操作成功！"),setTimeout(function(){d.closeAll()},1600),m.screenfields[2].value1=j("date")(new Date-2592e6,"yyyy-MM-dd HH:mm"),m.screenfields[2].value2=j("date")(new Date,"yyyy-MM-dd HH:mm"),a.fetchData()):f.autoclose(e)}).error(function(a){f.autoclose(i.errorResult(a))})},q=function(a,b,d,e,g){b.ngDialogPromise=c({method:"post",url:d,data:i.getFormData(e)}).success(function(c){var d=c.State.Code,e=c.State.Message;0===d?(f.autoclose("新增成功！"),l(a),setTimeout(function(){b.closeThisDialog()}),g&&m()):f.autoclose(e)}).error(function(a){f.autoclose(i.errorResult(a))})},r=function(a){var b=a;d.openConfirm({template:"creatNewsTypes",controller:["$scope",function(a){a.TitleText="新增新闻类型",a.fieldsList=[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:"",originValue:""}],a.formSubmit=function(){q(b,a,h.inCategory,a.fieldsList)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},s=function(a){for(var b=a.ChannelType,c="",d=0;d<b.length;d++)c+=b[d].Id+",";c=c.substring(0,c.length-1),a.ChannelType=c};a.addScope=function(){var b=k.defer(),c=b.promise;m(a,b),c.then(function(){var b=a.fetchData;d.openConfirm({template:"creatNewsTypes",controller:["$scope",function(a){a.TitleText="新增发布范围",a.fetchData=b,a.fieldsList=[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:"",originValue:""}],a.formSubmit=function(){q(null,a,h.inChanneltype,a.fieldsList,!0)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})})},a.creatOne=function(){var b=k.defer(),c=b.promise;m(a,b),c.then(function(){var b=a.newsTypes,c=a.publicationScope,e=a.news,f=a.fetchData,g=a;o(e),d.openConfirm({template:"createOne",controller:["$scope",function(a){a.TitleText="新增新闻发布",a.fetchData=f,a.newsTypes=b,a.publicationScope=c,a.news=e,a.disabled=!1,a.create=!0,a.news.CategoryId=a.newsTypes[0].Id,a.closeDialog=function(){d.closeAll()},a.formSubmit=function(){s(a.news),p(a,!1,a.news,!0,null,g)},a.saveDraft=function(){s(a.news),p(a,!0,a.news,!0,null,g)},a.creatNewsTypes=function(){r(a)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})})},a.editItem=function(b){var c=k.defer(),e=c.promise;0===a.publicationScope.length?m(a,c):1===a.newsTypes.length?l(a,c):c.resolve(),e.then(function(){var c=a.newsTypes,e=a.publicationScope,f=a.fetchData,g=a;d.openConfirm({template:"createOne",controller:["$scope",function(a){a.news=b,2===b.State?a.draft=!1:1===b.State&&(a.draft=!0),a.TitleText="修改",a.fetchData=f,a.newsTypes=c,a.publicationScope=e;var h=[];a.news.ChannelList.forEach(function(b,c){a.publicationScope.forEach(function(a,c){a.Id===b.ChannelTypeId&&h.push(a)})}),a.news.ChannelType=h,a.create=!1,a.closeDialog=function(){d.closeAll()},a.formSubmit=function(){s(a.news),p(a,!1,a.news,!1,b.Id,g)},a.saveDraft=function(){s(a.news),p(a,!0,a.news,!1,b.Id,g)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})})},a.publicationStatus=[{Id:0,Name:"全部"},{Id:1,Name:"草稿"},{Id:2,Name:"待审核"},{Id:4,Name:"审核失败"},{Id:5,Name:"已发布"}],a.Authors=[{Id:0,Name:"全部"},{Id:1,Name:"张三"},{Id:2,Name:"李四"},{Id:3,Name:"王五"}],a.newRangs=[{Id:0,Name:"全部"},{Id:1,Name:"社区"},{Id:2,Name:"街道"},{Id:3,Name:"小区"},{Id:4,Name:"楼栋"}],a.toggleItem=function(){f.autoclose("发布成功!","成功啦")};var t=function(d,e){var g=0,j="";switch(d){case!0:g=3,j="通过";break;case!1:g=4,j="不通过"}a.listBusyPromise=c({headers:b.gHeader,method:"get",url:h.reviewstateInformation+"?id="+e.Id+"&state="+g}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose("审核"+j),a.fetchData()):f.autoclose(d)}).error(function(a){f.autoclose(i.errorResult(a))})};a.checkItem=function(a){f.checkone("审核操作",function(){t(!0,a)},function(){t(!1,a)},"同意","拒绝",!1,!1,"请选择是否通过审核?")},a.screenfields=[{nameDisplay:"关键字",name:"title",value:"",editor:"normal"},{nameDisplay:"发布状态",name:"state",value:a.publicationStatus[0].Id,editor:"select",opts:a.publicationStatus},{nameDisplay:"发表时间",name:"startTimeAndendTime",name1:"startTime",name2:"endTime",value1:j("date")(new Date-2592e6,"yyyy-MM-dd HH:mm"),value2:j("date")(new Date,"yyyy-MM-dd HH:mm"),editor:"double-datePick"}],a.fetchData=function(){switch(a.selectItem.Id){case 1:a.searchOption=$.extend(!0,a.searchOption,n(a.screenfields)),a.searchOption.endTime=new Date(a.searchOption.endTime),a.searchOption.startTime=new Date(a.searchOption.startTime),i.fetchData(a,h.informationList,a.searchOption);break;case 2:i.fetchData(a,h.informationCategory,a.categoryOption);break;case 3:i.fetchData(a,h.channelTypelist,a.channelOption)}},a.fetchData(),a.isDisabled=function(a){return 1===a.State||4===a.State?!1:!0},a.fieldsList=[[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:""},{name:"Code",nameDisplay:"识别码",editor:"normal",required:!0,value:""}],[{name:"Name",nameDisplay:"栋座",editor:"select",required:!0,value:""}],[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:""}]],a.deleteCategory=function(b){a.listBusyPromise=c({method:"delete",url:h.addCategory+"?id="+b.Id}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose("删除成功！"),a.fetchData()):f.autoclose(d)}).error(function(a){f.autoclose(i.errorResult(a))})},a.editCategory=function(b){var c,e,f,g,j="",k=a.fetchData;2===a.selectItem.Id?(j=a.fieldsList[0],f=h.addCategory,g="新闻分类"):3===a.selectItem.Id&&(j=a.fieldsList[2],g="发布范围",f=b?h.upChanneltype:h.inChanneltype),b?(c="修改",e="put",i.bindFormData(b,j)):(c="新增",e="popt",i.initFormList(j)),d.openConfirm({template:"_createOne",controller:["$scope",function(a){a.TitleText=c+g,a.fieldsList=j,a.fetchData=k,a.formSubmit=function(){b?i.formSubmit(a,!1,a.fieldsList,f,b,null):i.formSubmit(a,!0,a.fieldsList,f,null,null)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},$("#datetimeStart").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,forceParse:0,format:"yyyy-mm-dd hh:ii",showMeridian:1}).on("click",function(a){$("#datetimeStart").datetimepicker()}),$("#datetimeEnd").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,forceParse:0,format:"yyyy-mm-dd hh:ii",showMeridian:1}).on("click",function(a){$("#datetimeEnd").datetimepicker()})}]);