/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("gongzuoliuCtrl",["$scope","$rootScope","$http","ngDialog","PagerExtends","$timeout","layerAlert","serverUrls","PcService","$q",function(a,b,c,d,e,f,g,h,i,j){a.list=[],a.searchOption={value:""},a.PcService=i,a.serverUrls=h,a.NodesList=[],a.workFlowId=0,a.WorkerType=0,a.StepId=0,a.NodeId=0,a.workId=0,a.workFlowGroup=[],a.DemocraticProjects=[],a.moreAndMoreList=[],a.ScoreTypes=[{Id:0,Name:"请选择"}],a.Roles=[{Id:0,Name:"请选择"}],a.moreAndMoreListChild=[{IntegerValue:-1,DisplayName:"请选择"}],a.NodeWorkerType=0,a.choseWorkerPropertyName=function(b){a.moreAndMoreList.forEach(function(c,d){c.PropertyName===b&&(a.moreAndMoreListChild=c.EnumDefined)})},a.NodeWorkerTypes=[{Id:1,Name:"审核"},{Id:2,Name:"普通"}],a.ExpectForms=[{Id:1,Name:"流动人口"},{Id:2,Name:"环境卫生"},{Id:3,Name:"纠纷调解"},{Id:4,Name:"重点人群"}],a.AuditStates=[{Id:0,Name:"未审核"},{Id:1,Name:"审核通过"},{Id:2,Name:"审核驳回"}],a.WorkflowNodeNotifyType=[{Id:0,Name:"无"},{Id:1,Name:"需要指定并推送工作组成员"},{Id:2,Name:"指定工作组，由工作组成员自行决定是否执行"}],a.toggleItem=function(b){i.toggleStatus(a,b,h.upWorkflow)},a.toggleText=function(a){var b="";switch(a){case 1:b="工作流模板";break;case 2:b="工作流节点模板";break;case 3:b="工作流工作模板";break;case 4:b="积分规则"}return b},a.ExtraResourceTypes=[{Checked:!1,Id:1,Name:"无"},{Checked:!1,Id:2,Name:"表单填写"},{Checked:!1,Id:4,Name:"线上民主协商"},{Checked:!1,Id:8,Name:"线下民主协商"},{Checked:!1,Id:16,Name:"线上临时协商"},{Checked:!1,Id:32,Name:"线下临时协商"},{Checked:!1,Id:64,Name:"核实"},{Checked:!1,Id:128,Name:"入库"}],a.AuditRejectHandleOptions=[{Id:0,Name:"退回上一节点"},{Id:1,Name:"不处理，仅仅记录审核状态"},{Id:2,Name:"退回第一节点"},{Id:3,Name:"废弃"}],a.checkedGroup=[{Id:1,Name:"工作流模板",Active:!0,Disabled:!1},{Id:2,Name:"工作流节点模板",Active:!1,Disabled:!0},{Id:3,Name:"工作流工作模板",Active:!1,Disabled:!0},{Id:4,Name:"积分规则",Active:!1,Disabled:!0}],a.checkedItem={Id:1,Name:"工作流模板",Active:!0,disabled:!0},a.checked=function(b,c){b.Disabled||(a.checkedGroup.forEach(function(a,c){c<b.Id?(a.Active=!1,a.Disabled=!1):(a.Active=!1,a.Disabled=!0)}),b.Active=!0,b.disabled=!1,a.checkedItem=b,a.fetchData())},a.OpenStates=[{Id:1,Name:"启用"},{Id:2,Name:"停用"}],a.NodeRelationships=[{Id:0,Name:"互斥"},{Id:1,Name:"互斥(按顺序)"},{Id:2,Name:"全部须完成"}],a.fieldsList=[[{name:"Name",nameDisplay:"工作流名称",editor:"normal",required:!0,value:"",originValue:""},{name:"Description",nameDisplay:"描述",editor:"textarea",required:!1,value:"",originValue:""},{name:"Note",nameDisplay:"备注",editor:"textarea",required:!1,value:"",originValue:""}],[{name:"Name",nameDisplay:"节点名称",editor:"normal",required:!0,value:"",originValue:""},{name:"PreviousNodeId",nameDisplay:"上级节点",editor:"select",required:!0,value:"",opts:a.NodesList,originValue:0},{name:"Note",nameDisplay:"备注",editor:"textarea",required:!1,value:"",originValue:""},{name:"Description",nameDisplay:"描述",editor:"textarea",required:!1,value:"",originValue:""},{name:"NotifyBeforeVaildEndTime",nameDisplay:"还剩",editor:"normal-select",required:!1,value:"",lastName:"自动催办",originValue:"",opts:[{Id:1,Name:"天"},{Id:2,Name:"时"},{Id:3,Name:"分"}],value1:1},{name:"TipForEndUser",nameDisplay:"用戶提示",editor:"normal",required:!1,value:"",originValue:""},{name:"GroupId",nameDisplay:"工作组",editor:"select",required:!1,value:"",originValue:""},{name:"RoleMembers",nameDisplay:"选择角色",editor:"multiselect",required:!1,value:"",originValue:[],opts:a.Roles},{name:"NotifyType",nameDisplay:"通知类型",editor:"select",required:!1,value:"",opts:a.WorkflowNodeNotifyType,originValue:0}],[[{name:"Name",nameDisplay:"工作名称",editor:"normal",required:!0,value:"",originValue:""},{name:"AuditState",nameDisplay:"审核状态",editor:"select",required:!0,value:"",opts:a.AuditStates,originValue:a.AuditStates[0].Id},{name:"RejectOption",nameDisplay:"审核处理选项",editor:"select",required:!0,value:"",opts:a.AuditRejectHandleOptions,originValue:a.AuditRejectHandleOptions[0].Id},{name:"Description",nameDisplay:"描述",editor:"textarea",required:!1,value:"",originValue:""},{name:"Note",nameDisplay:"备注",editor:"textarea",required:!1,value:"",originValue:""}],[{name:"Name",nameDisplay:"工作名称",editor:"normal",required:!0,value:"",originValue:""},{name:"Description",nameDisplay:"描述",editor:"textarea",required:!1,value:"",originValue:""},{name:"Note",nameDisplay:"备注",editor:"textarea",required:!1,value:"",originValue:""}]],[{name:"Name",nameDisplay:"名称",editor:"normal",required:!0,value:"",originValue:""},{name:"EqaulsState",nameDisplay:"触发节点状态",editor:"select",required:!0,value:"",originValue:1,opts:[{Id:1,Name:"开始运行"},{Id:2,Name:"完成"}]},{name:"MemberType",nameDisplay:"人员类型",editor:"select",required:!0,value:"",originValue:0,opts:[{Id:0,Name:"工作流创建者"},{Id:1,Name:"工作流关联人员"},{Id:2,Name:"工作者处理人员"}]},{name:"OpenState",nameDisplay:"启用状态",editor:"select",required:!0,value:"",opts:[{Id:1,Name:"启用"},{Id:2,Name:"停用"}],originValue:1},{name:"PointAmount",nameDisplay:"积分数量",editor:"normal",required:!0,value:"",originValue:""},{name:"RemotePointTypeCode",nameDisplay:"积分类型",editor:"select",required:!0,value:"",originValue:a.ScoreTypes[0].Id,opts:a.ScoreTypes},{name:"Description",nameDisplay:"描述",editor:"normal",required:!1,value:"",originValue:""},{name:"Note",nameDisplay:"备注",editor:"normal",required:!1,value:"",originValue:""}]];var k=function(a,b){a.listBusyPromise=c({method:"get",url:h.getPointtypelist+"?state=1"}).success(function(c){var d=c.State.Code,e=c.State.Message;0===d?(a.ScoreTypes=c.Content,a.ScoreTypes.forEach(function(a,b){a.Id=a.Code}),a.fieldsList[3].forEach(function(b,c){"RemotePointTypeCode"===b.name&&(b.opts=a.ScoreTypes,b.originValue=a.ScoreTypes[0].Id)}),b.resolve("sucess")):g.autoclose(e)}).error(function(a){g.autoclose(i.errorResult(a))})},l=function(a,b,d,e,f){a.ngDialogPromise=c({method:"get",url:h.workBindableproperties+"?workId="+b}).success(function(b){var c=b.State.Code,e=b.State.Message;0===c?(a.moreAndMoreInfo.moreAndMoreList=a.moreAndMoreList=b.Content.concat([{PropertyName:0,EnumCnName:"无"}]),a.moreAndMoreInfo.moreAndMoreListChild=a.moreAndMoreListChild=a.moreAndMoreList[0].EnumDefined?a.moreAndMoreList[0].EnumDefined:[],k(a,d)):g.autoclose(e)}).error(function(a){g.autoclose(i.errorResult(a))})},m=function(a,b,d,e){c({method:"get",url:h.extraRolemembersbynodeid+"?nodeid="+e.Id}).success(function(b){var c=b.State.Code,f=b.State.Message;0===c?(e.RoleMembers=b.Content,0!==a.NodesList.length?d.resolve("success"):d.reject("error")):g.autoclose(f)}).error(function(a){g.autoclose(i.errorResult(a))})},n=function(a,b,d,e){a.listBusyPromise=c({method:"get",url:h.autoNomyrolelist}).success(function(c){var f=c.State.Code,h=c.State.Message;0===f?(a.Roles=c.Content,b.forEach(function(b,c){"RoleMembers"===b.name&&(b.opts=a.Roles,b.originValue=[])}),e?e.RoleMembers?d.resolve("sucess"):m(a,b,d,e):d.resolve("sucess")):g.autoclose(h)}).error(function(a){g.autoclose(i.errorResult(a))})},o=function(a,b,d,e){a.listBusyPromise=c({method:"get",url:h.workflowNode+"?length=9999&currentPage=1&workflowid="+a.workFlowId}).success(function(c){var f=c.State.Code,h=c.State.Message;if(0===f){var i=c.Content.pagelist,j=[{Id:0,Name:"无上级节点"}];a.NodesList=j.concat(i),b.forEach(function(b,c){"PreviousNodeId"===b.name&&(b.opts=a.NodesList,b.originValue=0)}),d?n(a,b,d,e):d.resolve("sucess")}else g.autoclose(h)}).error(function(a){g.autoclose(i.errorResult(a))})},p=function(a,b,d,e){a.listBusyPromise=c({method:"get",url:h.workFlowgrouplist+"?length=9999&currentPage=1"}).success(function(c){var f=c.State.Code;c.State.Message;0===f&&(a.workFlowGroup=c.Content.pagelist,b.forEach(function(b,c){"GroupId"===b.name&&(b.opts=a.workFlowGroup,b.originValue=a.workFlowGroup[0]?a.workFlowGroup[0].Id:"")}),d&&o(a,b,d,e))}).error(function(a){g.autoclose(i.errorResult(a))})};a.creatOne=function(c){var e,f,g=j.defer(),k=g.promise,m="",n=a.fetchData,o="";switch(c){case 1:e=a.fieldsList[0],m="工作流模板",o=h.inWorkflow,f=null,g.resolve("sucess");break;case 2:e=a.fieldsList[1],m="工作流节点模板",o=h.workFlownode,f={WorkflowId:a.workFlowId},p(a,e,g);break;case 3:var q=a.fieldsList[2],r=a,s=a.NodeWorkerTypes,t=a.DemocraticProjects,u=a.ExtraResourceTypes;u.forEach(function(a,b){a.Disabled=!1}),m="工作流工作模板",f={NodeId:a.NodeId},g.resolve("sucess");break;case 4:e=a.fieldsList[3],m="积分规则",o=h.pointRule,f={WorkId:a.workId},a.moreAndMoreInfo={},l(a,a.workId,g)}k.then(function(g){if(4===c)var j=a.moreAndMoreInfo,k=a.ScoreTypes;d.openConfirm({template:"createOne",controller:["$scope",function(a){if(a.TitleText="新增",a.fetchData=n,a.tabTitleText=m,a.create=!0,a.newNodeWorkerType=1,a.index=c,a.param=f,a.disabledX=function(a,b){if(a.Checked)1===a.Id||16===a.Id||32===a.Id?b.forEach(function(a,b){a.Disabled=!1,1!==a.Id&&16!==a.Id&&32!==a.Id&&(a.Disabled=!0)}):b.forEach(function(b,c){b.Disabled=!1,b.Id!==a.Id&&(b.Disabled=!0)});else if(1===a.Id||16===a.Id||32===a.Id){var c=!1;if(b.forEach(function(a,b){(1===a.Id||16===a.Id||32===a.Id)&&a.Checked&&(c=ture)}),c)return;b.forEach(function(a,b){a.Disabled=!1})}else b.forEach(function(a,b){a.Disabled=!1})},3===c?(a.NodeWorkerTypes=s,a.ExtraResourceTypes=u,a.ExtraResource=a.ExtraResourceTypes[0].Id,a.ExtraResourceTypes.forEach(function(a,b){a.Checked=!1})):4===c&&(a.ScoreTypes=k,a.moreAndMoreList=j.moreAndMoreList,a.moreAndMoreListChild=j.moreAndMoreListChild,a.param.WorkerPropertyName=a.moreAndMoreList[0]?a.moreAndMoreList[0].PropertyName:"",a.param.WorkerPropertyValue=a.moreAndMoreListChild[0]?a.moreAndMoreListChild[0].IntegerValue:""),a.choseNodeWorkerType=function(b){switch(b){case 1:o=h.workAudit,e=q[0],r.WorkerType=1;break;case 2:o=h.workBlank,e=q[1],r.WorkerType=2}i.initFormList(e),a.url=o,a.fieldsList=e,a.newNodeWorkerType=b},3===c)switch(a.DemocraticProjects=t,o.ExtraResourceType=a.ExtraResourceType,a.newNodeWorkerType){case 1:o=h.workAudit,e=q[0],r.WorkerType=1;break;case 2:o=h.workBlank,e=q[1],r.WorkerType=2}i.initFormList(e),a.fieldsList=e,a.url=o,a.formSubmit=function(){if(3===c){var d=0;a.ExtraResourceTypes.forEach(function(a,b){a.Checked&&(d^=a.Id)}),a.param.ExtraResource=d}if(4===c){0===a.WorkerPropertyName&&(delete a.param.WorkerPropertyName,delete a.param.WorkerPropertyValue);var e=i.getFormData(a.fieldsList).RemotePointTypeCode,f="";a.ScoreTypes.forEach(function(a,b){a.Id===e&&(f=a.Name)}),a.param.RemotePointTypeName=f}i.formSubmit(a,!0,a.fieldsList,a.url,null,a.param,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},function(){},function(){})},a.fetchData=function(){var b,c;switch(a.checkedItem.Id){case 1:b=h.workflowList,i.fetchData(a,b,a.searchOption);break;case 2:c={workflowid:a.workFlowId},b=h.workflowNode,i.fetchData(a,b,c);break;case 3:c={nodeid:a.NodeId},b=h.getWorkbynodeid,i.fetchList(a,b,c,null,3);break;case 4:c={workId:a.workId},b=h.pointruleList,i.fetchData(a,b,c)}},a.fetchData(),a.toggeItem=function(a){var b;1===a.State?(b="停用",a.State=0):(b="启用",a.State=1),g.autoclose(b+"操作成功！")},a.editItem=function(c,e){var f,g,l,m="",n=a.fetchData,o=j.defer(),q=o.promise;switch(e){case 1:f=a.fieldsList[0],m="工作流模板",g=h.upWorkflow,l=null,o.resolve("sucess");break;case 2:f=a.fieldsList[1],m="工作流节点模板",g=h.workFlownode,l={WorkflowId:c.WorkflowId},p(a,f,o,c);break;case 3:l={NodeId:c.NodeId},m="工作流工作模板";var r=a.fieldsList[2];switch(a.WorkerType){case 1:g=h.workAudit,f=r[0];break;case 2:g=h.workBlank,f=r[1]}var s=a.WorkerType,t=a.ExtraResourceTypes;o.resolve("sucess");break;case 4:g=h.pointRule,m="积分规则",f=a.fieldsList[3],k(a,o),l={WorkId:c.WorkId}}q.then(function(h){if(4===e)var j=a.ScoreTypes;i.bindFormData(c,f),d.openConfirm({template:"createOne",controller:["$scope",function(a){if(a.param=l,a.TitleText="修改",a.tabTitleText=m,a.fetchData=n,a.create=!1,a.index=e,4===e&&(a.ScoreTypes=j),a.fieldsList=f,3===e){a.WorkerType=s,a.ExtraResourceTypes=t;var d=c.ExtraResource;a.ExtraResourceTypes.forEach(function(a,b){(d&a.Id)===a.Id?a.Checked=!0:a.Checked=!1});var h=!1;a.ExtraResourceTypes.forEach(function(a,b){return 1!==a.Id&&16!==a.Id&&32!==a.Id||!a.Checked?void 0:void(h=!0)}),h?a.ExtraResourceTypes.forEach(function(a,b){1!==a.Id&&16!==a.Id&&32!==a.Id?a.Disabled=!0:a.Disabled=!1}):a.ExtraResourceTypes.forEach(function(a,b){a.Disabled=!0,a.Checked&&(a.Disabled=!1)})}a.disabledX=function(a,b){if(a.Checked)1===a.Id||16===a.Id||32===a.Id?b.forEach(function(a,b){a.Disabled=!1,1!==a.Id&&16!==a.Id&&32!==a.Id&&(a.Disabled=!0)}):b.forEach(function(b,c){b.Disabled=!1,b.Id!==a.Id&&(b.Disabled=!0)});else if(1===a.Id||16===a.Id||32===a.Id){var c=!1;if(b.forEach(function(a,b){(1===a.Id||16===a.Id||32===a.Id)&&a.Checked&&(c=ture)}),c)return;b.forEach(function(a,b){a.Disabled=!1})}else b.forEach(function(a,b){a.Disabled=!1})},a.formSubmit=function(){if(3===e){var d=0;a.ExtraResourceTypes.forEach(function(a,b){a.Checked&&(d^=a.Id)}),a.param.ExtraResource=d}else if(4===e){var f=i.getFormData(a.fieldsList).RemotePointTypeCode,h="";a.ScoreTypes.forEach(function(a,b){a.Id===f&&(h=a.Name)}),a.param.RemotePointTypeName=h}i.formSubmit(a,!1,a.fieldsList,g,c,a.param,b.pHeader)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:600})},function(a){console.log(a)},function(a){console.log(a)})},a.configScore=function(b){a.workId=b.Id,a.checkedGroup[3].Disabled=!1,a.checked(a.checkedGroup[3])},a.configNode=function(b){a.WorkerType=b.WorkerType,a.NodeId=b.Id,a.checkedGroup[2].Disabled=!1,a.checked(a.checkedGroup[2])},a.configItem=function(b){a.workFlowId=b.Id,a.checkedGroup[1].Disabled=!1,a.checked(a.checkedGroup[1])}}]);