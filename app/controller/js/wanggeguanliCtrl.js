/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("wanggeguanliCtrl",["$scope","$rootScope","$http","ngDialog","PagerExtends","layerAlert","serverUrls","PcService","$q",function(a,b,c,d,e,f,g,h,i){a.list=[],a.TitleText="新增",a.Roles=[],a.searchOption={name:""},Array.prototype.contains=function(a){for(var b in this)if(this[b].Id===a.Id)return!0;return!1};var j=[{Id:0,Name:"请选择"}];a.department=[{Id:0,Name:"请选择"}],a.gender=[{Id:1,Name:"男"},{Id:2,Name:"女"}],a.employeeTypes=[{Id:1,Name:"区域管理员"},{Id:2,Name:"普通员工"}];var k=function(a){a.ngDialogPromise=c({method:"get",url:g.griderAll}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(a.Personnels=b.Content,a.gridAction.PersonnelId=a.Personnels[0]?a.Personnels[0].Id:""):f.autoclose(d)}).error(function(a){f.autoclose(h.errorResult(a))})},l=function(a){a.ngDialogPromise=c({method:"get",url:g.courtyardAll+"?openstate=0"}).success(function(b){var c=b.Content;a.unitField.opts1=j.concat(c)}).error(function(a){f.autoclose(h.errorResult(a))})},m=function(a,b){a.ngDialogPromise=c({method:"get",url:g.buildingAll+"?id="+b+"&type=1"}).success(function(b){var c=b.Content;a.unitField.opts2=j.concat(c),a.gridAction.BuildId=0,a.gridAction.UnitIds=0}).error(function(a){f.autoclose(h.errorResult(a))})},n=function(a,b){a.ngDialogPromise=c({method:"get",url:g.buildingAll+"?id="+b+"&type=2"}).success(function(b){var c=b.Content;a.unitField.opts3=j.concat(c),a.gridAction.UnitIds=0}).error(function(a){f.autoclose(h.errorResult(a))})},o=function(a,b){var c="";a.unitField.opts4.forEach(function(a,d){return a.Id===b?void(c=a.Name):void 0});var d={Id:b,Name:c};return a.checkedRoomList.contains(d)?void f.autoclose("已经添加过该户,无需重复添加!"):(a.checkedRoomList.push(d),a.gridAction.RoomId.push(d),void(a.showCheckSelect=!1))},p=function(a,b){a.ngDialogPromise=c({method:"get",url:g.unitHouseList+"?id="+b}).success(function(b){var c=b.Content;c.forEach(function(a,b){a.Name=a.RoomNumber}),a.unitField.opts4=j.concat(c),a.gridAction.RoomIds=0}).error(function(a){f.autoclose(h.errorResult(a))})},q=function(a,b,c){var d="";a.unitField.opts2.forEach(function(a,c){return a.Id===b?void(d=a.Name):void 0}),a.unitField.opts3.forEach(function(b,e){if(b.Id===c){var g={Id:b.Id,Name:d+""+b.Name};return a.checkedUnitList.contains(g)?void f.autoclose("已经添加过此单元了,无需重复添加!"):(a.checkedUnitList.push(g),void a.gridAction.UnitId.push(g))}}),a.showCheckSelect=!1},r=function(a){var b="";return a.forEach(function(a,c){b+=a.Id+","}),b=b.substring(0,b.length-1)},s=function(a,b,e,g,i,j){if(b){if(!g.UnitId||0===g.UnitId.length)return void f.autoclose("请至少选择一个单元!");g.UnitId=r(g.UnitId)}var k,l;switch(b){case!0:k="post",l="新增";break;case!1:k="put",l="修改",g.Id=j.Id}a.ngDialogPromise=c({headers:i?i:null,method:k,url:e,data:g}).success(function(b){var c=b.State.Code,e=b.State.Message;0===c?(f.autoclose(l+"操作成功！"),setTimeout(function(){d.close(0)},1600),a.fetchData()):f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})},t=function(a,b){h.fetchData(a,g.gridGangelist,{id:b,length:6,currentPage:1})},u=function(a,b,d,e,g){a.ngDialogPromise=c({method:"post",url:b,data:d}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose("新增成功!"),t(g,e),setTimeout(function(){a.closeThisDialog()},1600)):f.autoclose(d)}).error(function(a){f.autoclose(h.errorResult(a))})},v=function(a,b,d){a.ngDialogPromise=c({method:"delete",url:g.deGridgange+"?id="+b}).success(function(b){var c=b.State.Code,e=b.State.Message;0===c?(f.autoclose("删除成功!"),t(a,d)):f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})};a.deleteItem=function(c){h.deleteItem(a,g.deGrid,c,b.pHeader)},a.configItem=function(b){var c=a.fetchData;d.openConfirm({template:"configOne",controller:["$scope",function(a){a.create=!0,a.TitleText="自治单元配置",a.fetchData=c,a.Gangelist=[],t(a,b.Id),a.deleteCell=function(c){v(a,c.Id,b.Id)},a.createCell=function(){var c=a.fetchData,e=a;d.openConfirm({template:"addCell",controller:["$scope",function(a){a.TitleText="新增单元",a.fetchData=c,a.showCheckSelect=!1,a.checkedUnitList=[],a.gridAction={PersonnelId:0,CourtyardId:0,BuildId:0,UnitIds:0,UnitId:[]},a.unitField={editable:!1,opts1:[{Id:0,Name:"请选择"}],opts2:[{Id:0,Name:"请选择"}],opts3:[{Id:0,Name:"请选择"}],value1:0,value2:0,value3:0,required:!0},a.showCheckSelectAction=function(){a.showCheckSelect=!a.showCheckSelect,a.showCheckSelect&&(1===a.unitField.opts1.length&&0===a.unitField.opts1[0].Id||0===a.unitField.opts1.length)&&l(a)},a.choseCourtyard=function(b){m(a,b)},a.choseBuilds=function(b){n(a,b)},a.choseUnits=function(b,c){0!==c&&q(a,b,c)},a.closeUnit=function(){a.showCheckSelect=!1},a.closeDialog=function(){a.closeThisDialog()},a.submitAddcell=function(){var c="";if(a.gridAction.UnitId&&a.gridAction.UnitId.length>0&&a.gridAction.UnitId.forEach(function(a,b){c+=a.Id+","}),c=c.substring(0,c.length-1),!c)return void f.autoclose("您未选择任何单元！");var d={GridId:b.Id,UnitId:c};u(a,g.inGridrange,d,b.Id,e)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},a.createRoom=function(){var c=a.fetchData,e=a;d.openConfirm({template:"addCell",controller:["$scope",function(a){a.TitleText="新增户",a.fetchData=c,a.showCheckSelect=!1,a.checkedUnitList=[],a.checkedRoomList=[],a.gridAction={PersonnelId:0,CourtyardId:0,BuildId:0,UnitIds:0,UnitId:[],RoomIds:0,RoomId:[]},a.unitField={editable:!1,opts1:[{Id:0,Name:"请选择"}],opts2:[{Id:0,Name:"请选择"}],opts3:[{Id:0,Name:"请选择"}],opts4:[{Id:0,Name:"请选择"}],value1:0,value2:0,value3:0,value4:0,required:!0},a.showCheckSelectAction=function(){a.showCheckSelect=!a.showCheckSelect,a.showCheckSelect&&(1===a.unitField.opts1.length&&0===a.unitField.opts1[0].Id||0===a.unitField.opts1.length)&&l(a)},a.choseCourtyard=function(b){m(a,b)},a.choseBuilds=function(b){n(a,b)},a.choseUnits=function(b,c){p(a,c)},a.choseRooms=function(b){o(a,b)},a.closeUnit=function(){a.showCheckSelect=!1},a.closeDialog=function(){a.closeThisDialog()},a.submitAddcell=function(){var c="";if(a.gridAction.RoomId&&a.gridAction.RoomId.length>0&&a.gridAction.RoomId.forEach(function(a,b){c+=a.Id+","}),c=c.substring(0,c.length-1),!c)return void f.autoclose("您未选择任何户！");var d={GridId:b.Id,LocationId:c};u(a,g.addGridrange,d,b.Id,e)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})};var w=function(b){a.listBusyPromise=c({method:"get",url:g.autoNomyrolelist}).success(function(c){var d=c.State.Code,e=c.State.Message;0===d?(a.Roles=c.Content,b.resolve("success")):f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})};a.creatOne=function(){var c=i.defer(),e=c.promise;0===a.Roles.length?w(c):c.resolve("success"),e.then(function(c){var e=a.Roles,f=a.Personnels,h=a.fetchData;d.openConfirm({template:"createOne",controller:["$scope",function(a){a.create=!0,a.TitleText="新增自治单元",a.fetchData=h,a.Roles=e,a.gridAction={PersonnelId:0,CourtyardId:0,BuildId:0,UnitIds:0,UnitId:[],GridType:1,Code:a.Roles[0].Code},a.typeList=[{Id:1,Name:"自治"},{Id:2,Name:"网格"}],a.checkedUnitList=[],a.unitField={editable:!1,opts1:[{Id:0,Name:"请选择"}],opts2:[{Id:0,Name:"请选择"}],opts3:[{Id:0,Name:"请选择"}],value1:0,value2:0,value3:0,required:!0},a.showCheckSelect=!1,a.showCheckSelectAction=function(){a.showCheckSelect=!a.showCheckSelect,a.showCheckSelect&&(1===a.unitField.opts1.length&&0===a.unitField.opts1[0].Id||0===a.unitField.opts1.length)&&l(a)},a.choseCourtyard=function(b){m(a,b)},a.choseBuilds=function(b){n(a,b)},a.choseUnits=function(b,c){0!==c&&q(a,b,c)},a.closeUnit=function(){a.showCheckSelect=!1},a.Personnels=f,(0===a.Personnels.length||1===a.Personnels.length&&0===a.Personnels[0].Id)&&k(a),a.formSubmit=function(){s(a,!0,g.inGrid,a.gridAction,b.pHeader)},a.closeDialog=function(){d.closeAll()}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},function(a){console.log(a)},function(a){console.log(a)})};var x=function(a,b){b.gridAction.Id=a.Id,b.gridAction.Name=a.Name,b.gridAction.GridType=a.GridType,b.gridAction.Code=a.AutonomyRoleCode};a.editItem=function(c){var e=i.defer(),f=e.promise;0===a.Roles.length?w(e):e.resolve("success"),f.then(function(e){var f=a.Roles,h=a.Personnels,i=a.fetchData;d.openConfirm({template:"createOne",controller:["$scope",function(a){a.create=!1,a.TitleText="修改基本信息",a.fetchData=i,a.Roles=f,a.gridAction={PersonnelId:0,CourtyardId:0,BuildId:0,UnitIds:0,GridType:1,Code:a.Roles[0].Code},a.typeList=[{Id:1,Name:"自治"},{Id:2,Name:"网格"}],x(c,a),a.checkedUnitList=[],a.unitField={editable:!1,opts1:[{Id:0,Name:"请选择"}],opts2:[{Id:0,Name:"请选择"}],opts3:[{Id:0,Name:"请选择"}],value1:0,value2:0,value3:0,required:!0},a.showCheckSelect=!1,a.showCheckSelectAction=function(){a.showCheckSelect=!a.showCheckSelect,a.showCheckSelect&&(1===a.unitField.opts1.length&&0===a.unitField.opts1[0].Id||0===a.unitField.opts1.length)&&l(a)},a.choseCourtyard=function(b){m(a,b)},a.choseBuilds=function(b){n(a,b)},a.choseUnits=function(b,c){0!==c&&q(a,b,c)},a.choseUnit=function(){a.showCheckSelect=!1},a.Personnels=h,(0===a.Personnels.length||1===a.Personnels.length&&0===a.Personnels[0].Id)&&k(a),a.formSubmit=function(){s(a,!1,g.upGrid,a.gridAction,b.pHeader,c)},a.closeDialog=function(){d.closeAll()}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},function(a){console.log(a)},function(a){console.log(a)})},a.toggleText=function(a){var b;switch(a.OpenState){case 2:b="启用";break;case 1:b="停用";break;default:b="无"}return b},a.toggleClass=function(a){var b={"btn-success":2===a.OpenState,"btn-danger":1===a.OpenState};return b},a.toggleItem=function(b){h.toggleItem(a,b,g.personnelState)},a.fetchData=function(){h.fetchData(a,g.gridList,a.searchOption)},a.fetchData(),a.numberTOText=function(a,b){var c;return b.forEach(function(b,d){b.Id===a&&(c=b.Name)}),c},a.UnitList=[{Id:0,Name:"请选择"},{Id:1,Name:"请选择"},{Id:2,Name:"请选择"},{Id:3,Name:"请选择"}],a.Personnels=[{Id:0,Name:"请选择"}],a.fieldsList=[{name:"Name",nameDisplay:"区域名称",editor:"normal",required:!0,value:"",originValue:""},{name:"PersonnelId",nameDisplay:"区域管理员",editor:"select",required:!0,value:"",opts:a.Personnels,originValue:0},{name:"UnitId",nameDisplay:"单元",editor:"multi-select",required:!0,value:"",originValue:0,opts:a.UnitList}]}]);