/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("fangwuguanliCtrl",["$scope","$rootScope","$http","ngDialog","PagerExtends","layerAlert","serverUrls","PcService","$q",function(a,b,c,d,e,f,g,h,i){a.lists=[[],[],[],[]];var j=(localStorage.getItem("menuItems"),JSON.parse(localStorage.getItem("myRoleInfo")));"superManager"===j.RoleName&&(a.ifNew=!0),a.list=[],a.residentList=[],a.TitleText="新增",a.create=!0,a.selectedItem={},a.searchLists={list1:[{Id:0,Nmae:"请选择"}],list2:[{Id:0,Nmae:"请选择"}],list3:[{Id:0,Nmae:"请选择"}],list4:[{Id:0,Nmae:"请选择"}]},a.searchOption={name:"",courtyardid:0,buildingid:0,unitid:0},a.showOption=[!0,!1,!1,!1];var k=function(a){a.forEach(function(a,b){"complex"===a.editor?a.values=["","",""]:a.value=a.originValue})},l=function(b){b.forEach(function(b,c){"courtyardId"===b.name?(b.opts=a.searchLists.list1,b.originValue=a.searchOption.courtyardid):"buildingId"===b.name?(b.opts=a.searchLists.list2,b.originValue=a.searchOption.buildingid):"unitId"===b.name?(b.opts=a.searchLists.list3,b.originValue=a.searchOption.unitid):"floorId"===b.name&&(b.opts=a.searchLists.list4,b.originValue=a.searchLists.list4[0].Id)}),k(a.fieldsList)},m=function(b){c({method:"get",url:g.buildingAll+"?id="+b+"&type=3"}).success(function(b){var c=b.Content;a.searchLists.list4=c,l(a.fieldsList),c.length>0||f.autoclose("楼层列表为空！")}).error(function(a){f.autoclose(h.errorResult(a))})},n=function(b,d,e){c({method:"get",url:g.buildingAll+"?id="+b+"&type=2"}).success(function(b){var c=b.Content;a.searchLists.list3=c,c.length>0?(a.searchOption.unitid=c[0].Id,(d||e)&&a.fetchData(a.checkedItem.Id)):(a.searchLists.list4=[],f.autoclose("房屋列表为空！"))}).error(function(a){f.autoclose(h.errorResult(a))})},o=function(b,d,e){c({method:"get",url:g.buildingAll+"?id="+b+"&type=1"}).success(function(b){var c=b.Content;if(a.searchLists.list2=c,c.length>0){a.searchOption.buildingid=c[0].Id;var f=c[0].Id;if(d)return void a.fetchData(a.checkedItem.Id);n(f,!1,e)}else a.searchLists.list3=a.searchLists.list4=[],a.checkedItem.Id>=3&&(a.list=[])}).error(function(a){f.autoclose(h.errorResult(a))})},p=function(b){c({method:"get",url:g.courtyardAll+"?openstate=1"}).success(function(c){var d=c.Content;if(a.searchLists.list1=d,d.length>0){a.searchOption.courtyardid=a.searchOption.courtyardid?a.searchOption.courtyardid:d[0].Id;var e=d[0].Id;if(b)return void a.fetchData(a.checkedItem.Id);o(e)}else f.autoclose("院落列表为空！"),a.checkedItem.Id>=2&&(a.list=[])}).error(function(a){f.autoclose(h.errorResult(a))})};a.newOneFormList=[[{name:"Name",nameDisplay:"院落名称",editor:"normal",required:!0,value:"",originValue:""},{name:"Address",nameDisplay:"院落街道地址",editor:"normal",required:!0,value:"",originValue:""},{name:"TotalBuilding",nameDisplay:"总栋数",editor:"normal",required:!1,value:"",originValue:""},{name:"households",nameDisplay:"总户数",editor:"normal",required:!1,value:"",originValue:""},{name:"PropertyFee",nameDisplay:"物业费",editor:"normal",required:!1,value:"",originValue:""},{name:"PropertyCompany",nameDisplay:"物业公司",editor:"normal",required:!1,value:"",originValue:""},{name:"PropertyAddress",nameDisplay:"物管办公地点",editor:"normal",required:!1,value:"",originValue:""},{name:"PropertyPhone",nameDisplay:"物管电话",editor:"normal",required:!1,value:"",originValue:""},{name:"Longitude",nameDisplay:"经度",editor:"normal",required:!1,value:"",originValue:""},{name:"Latitude",nameDisplay:"纬度",editor:"normal",required:!1,value:"",originValue:""},{name:"Remark",nameDisplay:"备注",editor:"normal",required:!1,value:"",originValue:""}],[{name:"courtyardId",nameDisplay:"院落",editor:"select",required:!0,value:"",originValue:"",editable:!0},{name:"building",nameDisplay:"栋座名称",editor:"normal",required:!0,value:"",originValue:""},{editor:"normal",name:"unitNum",nameDisplay:"单元数",required:!0,value:"",originValue:""},{name:"date",nameDisplay:"层户数",editor:"complex",required:!0,values:["","",""],originValues:["","",""]},{name:"type",nameDisplay:"房号规则",editor:"select",required:!0,value:"",opts:[{Id:1,Name:"平层递增"},{Id:2,Name:"整栋递增"}],originValue:1}],[{name:"courtyardId",nameDisplay:"院落",editor:"select",required:!0,value:"",originValue:"",editable:!0},{name:"buildingId",nameDisplay:"栋座",editor:"select",required:!0,value:"",originValue:"",editable:!0},{editor:"normal",name:"name",nameDisplay:"单元",required:!0,value:"",originValue:""},{name:"date",nameDisplay:"层数",editor:"_complex",required:!0,values:["",""],originValues:["",""]}],[{name:"courtyardId",nameDisplay:"院落",editor:"select",required:!0,value:"",originValue:"",editable:!0},{name:"buildingId",nameDisplay:"栋座",editor:"select",required:!0,value:"",originValue:"",editable:!0},{name:"unitId",nameDisplay:"单元",editor:"select",required:!0,value:"",originValue:"",editable:!0},{editor:"select",name:"floorId",nameDisplay:"楼层",required:!0,value:"",originValue:""},{editor:"normal",name:"name",nameDisplay:"房号",required:!0,value:"",originValue:""}]],a.fieldsList=a.newOneFormList[0],a.checkChange=function(b,c){if(a.checkedItem.Id===c)return a.fetchData(a.checkedItem.Id),!1;var d;switch(d=a.checkedItem.Id>c?!0:!1,c){case 1:p(b,!1,d);break;case 2:o(b,!1,d);break;case 3:n(b,!1,d)}},a.navTabList=[{Id:1,Name:"院落列表",Active:!0,talbeTitle:["序号","院落名称","院落街道地址","总栋数","总户数","物管电话","备注","操作"]},{Id:2,Name:"楼栋列表",Active:!1,talbeTitle:["序号","院落名称","楼座","楼座单元数","总层数","平层户数","总户数"]},{Id:3,Name:"单元列表",Active:!1,talbeTitle:["序号","院落名称","楼栋","单元"]},{Id:4,Name:"房屋列表",Active:!1,talbeTitle:["序号","院落名称","栋座","单元","房号","操作"]}],a.checkedItem=a.navTabList[0],a.checked=function(b){switch(console.log(a.searchLists),a.checkedItem=b,a.fieldsList=a.newOneFormList[b.Id-1],1===b.Id&&a.fetchData(b.Id),b.Id){case 1:a.showOption=[!0,!1,!1,!1];break;case 2:a.showOption=[!1,!0,!1,!1],a.showOption[b.Id-1]&&p(!0);break;case 3:a.showOption=[!1,!0,!0,!1],a.showOption[b.Id-1]&&o(a.searchOption.courtyardid,!0);break;case 4:a.showOption=[!1,!0,!0,!0],a.showOption[b.Id-1]&&a.searchLists.list2.length>0&&n(a.searchOption.buildingid,!0)}a.navTabList.forEach(function(a,c){a.Name===b.Name?a.Active=!0:a.Active=!1})};a.fetchData=function(b){var c=a.searchLists.list1;(1===c.length&&0===c[0].Id||0===c.length)&&p();var d="",h={};switch(b){case 1:d=g.courtyardList;break;case 2:d=g.buildingList;break;case 3:d=g.unitList;break;case 4:d=g.houseList}h=$.extend(!0,h,a.searchOption),e.regListSpecifyPage(a,{apiUrl:d,params:h,success:function(c){a.lists[b-1]=c,a.list=a.lists[b-1],0===a.lists[1].length&&(a.lists[2]=[],a.lists[3]=[])},error:function(b){a.list=[],f.autoclose("当前状态下暂无数据！")}})},a.fetchData(1),a.creatOne=function(){var b=450,c=1;switch(a.checkedItem.Id){case 1:b=850,c=2,l(a.fieldsList);break;case 2:l(a.fieldsList);break;case 3:l(a.fieldsList);break;case 4:m(a.searchOption.unitid)}d.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.fieldsList=a.newOneFormList[a.checkedItem.Id-1],a.column=c,a.TitleText="新增",a.create=!0}],className:"ngdialog-theme-default",closeByEscape:!0,closeByDocument:!1,width:b})},a.getSubmitData=function(b,c){var d={};return b||(d.Id=a.selectedItem.Id),c.forEach(function(a,b){if("complex"===a.editor){var c=a.values[0]+"_"+a.values[1]+"_"+a.values[2];d[a.name]=c}else if("_complex"===a.editor){var e=a.values[0]+"_"+a.values[1];d[a.name]=e}else d[a.name]=a.value}),d},a.formSubmit=function(b,e){var i=a.getSubmitData(b,a.fieldsList),j="",k="",l="";if(b)switch(l="新增",j="post",e){case 1:k=g.inCourtyard;break;case 2:k=g.inItialization;break;case 3:k=g.inUnit;break;case 4:k=g.inHouse;break;default:return void f.autoclose("找不到提交url")}else switch(j="put",k=g.upcourtyard,l="编辑",e){case 1:k=g.upcourtyard;break;case 2:k=g.upcourtyard;break;case 3:k=g.upcourtyard;break;case 4:k=g.upcourtyard;break;default:return void f.autoclose("找不到提交url")}a.ngDialogPromise=c({method:j,url:k,data:i}).success(function(b){var c=b.State.Code,e=b.State.Message;0===c?(f.autoclose(l+"操作成功！"),a.fetchData(a.checkedItem.Id),setTimeout(function(){d.closeAll()},1600)):f.autoclose(e)}).error(function(a){f.autoclose(h.errorResult(a))})},a.bindData=function(a,b){a&&a.length>0&&a.forEach(function(a,c){void 0!==b[a.name]&&(a.value=b[a.name])})},a.editItem=function(b){a.bindData(a.fieldsList,b),a.selectedItem=b;var c=450,e=1;switch(a.checkedItem.Id){case 1:c=850,e=2;break;case 2:break;case 3:break;case 4:}var f=a.newOneFormList[a.checkedItem.Id-1];d.openConfirm({template:"createOne",scope:a,controller:["$scope",function(a){a.fieldsList=f,a.column=e,a.TitleText="修改",a.create=!1}],className:"ngdialog-theme-default",closeByEscape:!0,closeByDocument:!1,width:c})},a.residentItem=function(b){var e=i.defer(),j=e.promise;a.listBusyPromise=c({method:"get",url:g.houseResident+"?id="+b.Id}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(a.residentList=b.Content,e.resolve()):f.autoclose(d)}).error(function(a){f.autoclose(h.errorResult(a))}),j.then(function(){d.openConfirm({template:"listOne",scope:a,controller:["$scope",function(a){a.type="resident",a.TitleText="查看居民",a.residentList=a.$parent.$parent.residentList,a.PcService=h,a.matterList=[{Id:1,Name:"户主"},{Id:2,Name:"配偶"},{Id:3,Name:"子女"},{Id:4,Name:"父母"},{Id:5,Name:"岳父母/公婆"},{Id:6,Name:"祖父母"},{Id:7,Name:"媳婿"},{Id:8,Name:"孙子女"},{Id:9,Name:"兄弟姐妹"},{Id:10,Name:"其他"}],a.Sexs=[{Id:1,Name:"男"},{Id:2,Name:"女"}]}],className:"ngdialog-theme-default",closeByEscape:!0,closeByDocument:!1,width:600})})},a.vehicleItem=function(b){var c=i.defer(),h=c.promise;e.regListSpecifyPage(a,{apiUrl:g.vehiclelist,params:{houseId:b.Id},success:function(b){a.vehicleList=b,c.resolve()},error:function(a){f.autoclose(errorResult(a))}}),h.then(function(){d.openConfirm({template:"listOne",scope:a,controller:["$scope",function(a){a.type="vehicle",a.TitleText="查看车辆",a.vehicleList=a.$parent.$parent.vehicleList}],className:"ngdialog-theme-default",closeByEscape:!0,closeByDocument:!1,width:600})})};var q=function(b,d){var e;switch(b){case 2:e=g.deBuilding;break;case 3:e=g.deUnit;break;case 4:e=g.deHouse}a.listBusyPromise=c({method:"delete",url:e+"?id="+d}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose("删除成功！"),a.fetchData(a.checkedItem.Id)):f.autoclose(d)}).error(function(a){f.autoclose(h.errorResult(a))})};a.deleteItem=function(a,b){f.checkone("执行删除操作",function(){q(a,b.Id)},function(){},"确定","取消",!0,!0)},a.toggleItem=function(b){var d=0,e="";switch(b.OpenState){case 1:d=2,e="停用";break;case 2:d=1,e="启用"}(2===d||1===d)&&(a.listBusyPromise=c({method:"get",url:g.whetherState+"?id="+b.Id+"&state="+d}).success(function(b){var c=b.State.Code,d=b.State.Message;0===c?(f.autoclose(e+"操作成功!"),a.fetchData(a.checkedItem.Id)):f.autoclose(d)}).error(function(a){f.autoclose(h.errorResult(a))}))},a.isToggle=function(a){return{"btn-success":2===a.OpenState,"btn-danger":1===a.OpenState}},a.toggleText=function(a){var b;switch(a.OpenState){case 2:b="启用";break;case 1:b="停用";break;default:b="无"}return b}}]);