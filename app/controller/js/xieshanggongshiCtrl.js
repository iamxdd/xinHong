/*!qinglongWeb-1.0.0 2017-11-01*/
App.controller("xieshanggongshiCtrl",["$scope","$rootScope","$filter","$http","ngDialog","PagerExtends","layerAlert","$interval","serverUrls","PcService",function(a,b,c,d,e,f,g,h,i,j){a.list=[],a.TitleText="创建项目协商",a.createOne=!1,a.searchOption={isPublicityString:!0},a.PcService=j,a.toggleText=function(a){var b;return b=3===a.NegotiateState?"开始公示":4===a.NegotiateState?"结束公示":"暂无操作"},a.disabledItem=function(a){var b=!1;return b=3===a.NegotiateState||4===a.NegotiateState?!1:!0},a.toggleClass=function(a){return{"btn-success":3===a.NegotiateState,"btn-danger":4===a.NegotiateState,"btn-default":3!==a.NegotiateState&&4!==a.NegotiateState}};var k=function(){var a=setInterval(function(){var b=$("#startAt"),c=$("#endAt");b&&c&&(b.datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,forceParse:0,format:"yyyy-mm-dd hh:ii",showMeridian:1}).on("click",function(){b.datetimepicker()}),c.datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,forceParse:0,format:"yyyy-mm-dd hh:ii",showMeridian:1}).on("click",function(){c.datetimepicker()}),clearInterval(a))},500)},l=function(a,b){b.ngDialogPromise=d({method:"get",url:i.negotiationGroupmembersbygid+"?gid="+a.Id}).success(function(b){var c=b.State.Code;b.State.Message;if(0===c){var d=b.Content;if(0===d.length)return void(a.Members="暂无成员");var e="";d.forEach(function(a,b){e+=a.MemberNickName+","}),a.Members=e.substring(0,e.length-1)}}).error(function(a){g.autoclose(j.errorResult(a))})},m=function(a,b){e.openConfirm({template:"seeGroup",controller:["$scope",function(a){a.TitleText="协商组查看",a.groupMembers=b,a.seeGroupMember=function(b){l(b,a)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})};a.seeMemberGroup=function(b){a.listBusyPromise=d({method:"get",url:i.negotiationGroupsbydpid+"?dpid="+b.Id}).success(function(a){var c=a.State.Code;a.State.Message;if(0===c){var d=a.Content;if(!d||0===d.length)return void g.autoclose("该议题下暂无协商组！");m(b,d)}}).error(function(a){g.autoclose(j.errorResult(a))})},a.creatOne=function(){e.openConfirm({template:"createOne",controller:["$scope",function(a){a.TitleText="创建项目协商",a.negObject={Title:"",isPublic:!1,BallotBox:1,ScoringTable:1,Member:1,StartAt:"2017-07-17 17:50",EndAt:"2017-07-17 19:50"},k(),a.BallotBoxList=[{Id:1,Name:"投票箱一"},{Id:2,Name:"投票箱二"},{Id:3,Name:"投票箱三"}],a.ScoringTableList=[{Id:1,Name:"评分表一"},{Id:2,Name:"评分表二"},{Id:3,Name:"评分表三"}],a.MemberList=[{Id:1,Name:"人员一"},{Id:2,Name:"人员二"},{Id:3,Name:"人员三"}],a.createFromSubmit=function(){g.autoclose("保存成功!")}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},a.formSubmit=function(){alert("新增成功！"),e.close()},a.publicityList=[{Id:!0,Name:"是"},{Id:!1,Name:"否"}],a.statusList=[{Id:0,Name:"未开始"},{Id:1,Name:"协商中"},{Id:2,Name:"取消"},{Id:3,Name:"结果统计中"},{Id:4,Name:"公示中"},{Id:5,Name:"已完成"}],a.publicityList=[{Id:"true",Name:"是"},{Id:"false",Name:"否"}],a.Consultation={Status:0,Publicity:0,CreateAt:"2017-07-17 17:50"},a.screenfields=[{nameDisplay:"关键字",name:"value",value:"",editor:"normal"},{nameDisplay:"创建时间",name:"timeFrom1970Ticks",name1:"createTimeFrom",name2:"createTimeTo",value1:c("date")(new Date-2592e6,"yyyy-MM-dd HH:mm"),value2:c("date")(new Date,"yyyy-MM-dd HH:mm"),editor:"double-datePick"}],a.fetchData=function(){var b=j.getFormData(a.screenfields);b=$.extend(!0,b,a.searchOption),j.fetchData(a,i.transacationList,b)},a.fetchData(),a.toggleItem=function(c){var f={},h="";if(3!==c.NegotiateState&&4!==c.NegotiateState)return void g.autoclose("当前状态下无法公示！");switch(c.NegotiateState){case 3:h="公示",f.NegotiateState=4;break;case 4:h="结束公示",f.NegotiateState=5}f=$.extend(!0,c,f),a.listBusyPromise=d({headers:b.pHeader,method:"put",url:i.demoCratictransaction,data:f}).success(function(b){var d=b.State.Code,f=b.State.Message;0===d?(g.autoclose(h+"操作成功!"),setTimeout(function(){e.closeAll()},1600),a.fetchData()):(5===c.NegotiateState?c.NegotiateState=4:4===c.NegotiateState&&(c.NegotiateState=3),g.autoclose(f))}).error(function(a){5===c.NegotiateState?c.NegotiateState=4:4===c.NegotiateState&&(c.NegotiateState=3),g.autoclose(j.errorResult(a))})},a.ConsultationRange=[{Id:1,Name:"范围一"},{Id:2,Name:"范围二"}],a.fieldsList=[{name:"Name",nameDisplay:"议题",editor:"normal",required:!0},{name:"Describe",nameDisplay:"议事时间",editor:"normal",required:!0,value:""},{name:"Describe",nameDisplay:"议事地点",editor:"select",required:!0,value:a.ConsultationRange[0].Id,opts:a.ConsultationRange},{name:"Describe",nameDisplay:"描述",editor:"textarea",required:!0,value:""},{name:"Describe",nameDisplay:"投票箱",editor:"normal",required:!0,value:""},{name:"Describe",nameDisplay:"评分表",editor:"normal",required:!0,value:""}],a.seeItem=function(a){e.openConfirm({template:"createOne",controller:["$scope",function(a){a.TitleText="项目概要",k(),a.negObject={isPublic:!1,BallotBox:1,ScoringTable:1,Member:1,StartAt:"2017-07-17 17:50",EndAt:"2017-07-17 19:50"},a.editable=!1,a.BallotBoxList=[{Id:1,Name:"投票箱一"},{Id:2,Name:"投票箱二"},{Id:3,Name:"投票箱三"}],a.ScoringTableList=[{Id:1,Name:"评分表一"},{Id:2,Name:"评分表二"},{Id:3,Name:"评分表三"}],a.MemberList=[{Id:1,Name:"人员一"},{Id:2,Name:"人员二"},{Id:3,Name:"人员三"}],a.createFromSubmit=function(){g.autoclose("保存成功!")},a.formSubmit=function(){e.close()}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},a.detailItem=function(a){e.openConfirm({template:"detailOne",controller:["$scope",function(a){a.TitleText="议事过程",a.wordsList=[{},{},{},{},{}],a.delete_Item=function(b){g.autoclose("删除成功！"),a.wordsList.splice(b.$index,1)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:850})},a.resultlItem=function(a){e.openConfirm({template:"resultOne",controller:["$scope",function(a){a.TitleText="议事结果",a.delete_Item=function(b){g.autoclose("删除成功！"),a.wordsList.splice(b.$index,1)},a.barData=[{label:"投票结果(%)",color:"#9cd159",data:[["赞成",88],["反对",12]]}],a.barOptions={series:{bars:{align:"center",lineWidth:0,show:!0,barWidth:.6,fill:.9}},grid:{borderColor:"#eee",borderWidth:1,hoverable:!0,backgroundColor:"#fcfcfc"},tooltip:!0,tooltipOpts:{content:function(a,b,c){return b+" : "+c}},xaxis:{tickColor:"#fcfcfc",mode:"categories"},yaxis:{position:a.app.layout.isRTL?"right":"left",tickColor:"#eee"},shadowSize:0}}],className:"ngdialog-theme-default",closeByDocument:!1,width:700})},a.subIssuesItem=function(a){var b=function(a){e.openConfirm({template:"voteAction",controller:["$scope",function(a){a.TitleText="查看投票",a.voteList=[{},{},{},{}],a.barData=[{label:"投票结果(%)",color:"#9cd159",data:[["赞成",88],["反对",12]]}],a.barOptions={series:{bars:{align:"center",lineWidth:0,show:!0,barWidth:.6,fill:.9}},grid:{borderColor:"#eee",borderWidth:1,hoverable:!0,backgroundColor:"#fcfcfc"},tooltip:!0,tooltipOpts:{content:function(a,b,c){return b+" : "+c}},xaxis:{tickColor:"#fcfcfc",mode:"categories"},yaxis:{position:"left",tickColor:"#eee"},shadowSize:0}}],className:"ngdialog-theme-default",closeByDocument:!1,width:700})},c=function(a){e.openConfirm({template:"scoreAction",controller:["$scope",function(a){a.TitleText="查看评分",a.scoreList=[{},{},{},{},{},{}]}],className:"ngdialog-theme-default",closeByDocument:!1,width:700})};e.openConfirm({template:"subIssues",controller:["$scope",function(a){a.TitleText="子议题",a.subIssuesList=[{},{},{},{}],a.seeVote=function(a){b(a)},a.seeScore=function(a){c(a)}}],className:"ngdialog-theme-default",closeByDocument:!1,width:700})},$("#datetimeStart").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,forceParse:0,format:"yyyy-mm-dd hh:ii",showMeridian:1}).on("click",function(a){$("#datetimeStart").datetimepicker()}),$("#datetimeEnd").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,forceParse:0,format:"yyyy-mm-dd hh:ii",showMeridian:1}).on("click",function(a){$("#datetimeEnd").datetimepicker()})}]);